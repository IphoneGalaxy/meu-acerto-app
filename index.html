<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meu Acerto</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Meu Acerto" />
  <meta name="theme-color" content="#4338ca" />
  <link rel="apple-touch-icon" href="https://placehold.co/180x180/4338ca/ffffff?text=Acerto" />

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase compat (v10) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .modal-enter { animation: fadeIn .2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(.98);} to { opacity: 1; transform: scale(1);} }
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useMemo, useRef } = React;
    const { createRoot } = ReactDOM;

    /* ================= Helpers ================= */
    const norm = (s) => (s ?? '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase();
    const canonicalSplit = (s) => {
      const n = norm(s);
      if (n.includes('guilherme')) return 'Guilherme';
      if (n.includes('thais')) return 'Thais';
      return 'Dividido';
    };
    const parseMoney = (input) => {
      if (typeof input === 'number') return input;
      if (!input) return NaN;
      const s = String(input).replace(/R\$\s?/gi,'').trim();
      if (/^-?\d+\.\d{2}$/.test(s) && !s.includes(',')) return Number(s);
      const n = parseFloat(s.replace(/\./g,'').replace(',','.'));
      return Number.isFinite(n) ? n : NaN;
    };
    const excelSerialToPT = (v) => {
      if (typeof v === 'number') {
        const ms = Math.round((v - 25569) * 86400 * 1000);
        return new Date(ms).toLocaleDateString('pt-PT', { timeZone: 'UTC' });
      }
      if (typeof v === 'string') {
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) return v;
        if (/^\d{4}-\d{2}-\d{2}/.test(v)) return new Date(v).toLocaleDateString('pt-PT', { timeZone: 'UTC' });
        const m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})$/);
        if (m) return `${m[1].padStart(2,'0')}/${m[2].padStart(2,'0')}/20${m[3]}`;
      }
      return new Date().toLocaleDateString('pt-PT', { timeZone: 'UTC' });
    };
    const formatBRL = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL'}).format(v || 0);
    const round2 = (v) => Math.round((v + Number.EPSILON)*100)/100;

    /* ================= UI Genéricos ================= */
    const Modal = ({ isOpen, onClose, children, titleId='modal-title' }) => {
      const contentRef = React.useRef(null);
      React.useEffect(() => {
        if (!isOpen) return;
        // focar uma vez o primeiro campo do modal
        setTimeout(() => {
          const node = contentRef.current;
          const focusables = node?.querySelectorAll('input,select,textarea,button,[tabindex]:not([tabindex="-1"])');
          (focusables?.[0] || node)?.focus();
        }, 0);

        const onKeyDown = (e) => {
          if (e.key === 'Escape') { e.preventDefault(); onClose?.(); }
          if (e.key === 'Tab') {
            const node = contentRef.current;
            const focusables = node?.querySelectorAll('input,select,textarea,button,[tabindex]:not([tabindex="-1"])');
            if (!focusables || !focusables.length) return;
            const first = focusables[0], last = focusables[focusables.length-1];
            if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
            else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
          }
        };
        document.addEventListener('keydown', onKeyDown);
        return () => document.removeEventListener('keydown', onKeyDown);
      }, [isOpen]); // não depende de onClose p/ não recriar em cada digitação

      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black/60 flex justify-center items-center p-4 z-50 modal-enter" onClick={onClose} aria-hidden="true">
          <div role="dialog" aria-modal="true" aria-labelledby={titleId}
               className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md m-4 outline-none"
               onClick={(e)=>e.stopPropagation()} ref={contentRef} tabIndex={-1}>
            {children}
          </div>
        </div>
      );
    };

    const UserSelectionScreen = ({ onSelectUser }) => {
      const users = ['Guilherme', 'Thais'];
      return (
        <div className="min-h-screen flex flex-col justify-center items-center p-6">
          <h1 className="text-4xl font-bold mb-2">Meu Acerto</h1>
          <p className="text-lg text-slate-600 dark:text-slate-400 mb-8">Quem está a usar?</p>
          <div className="space-y-4 w-full max-w-xs">
            {users.map(u => (
              <button key={u} onClick={()=>onSelectUser(u)}
                className={`w-full py-3 rounded-xl text-white font-semibold shadow-lg hover:brightness-110 transition
                 ${u==='Thais' ? 'bg-pink-600' : 'bg-indigo-600'}`}>
                {u}
              </button>
            ))}
          </div>
        </div>
      );
    };

    /* ================= Dashboard ================= */
    const Dashboard = ({ user, onLogout, db }) => {
      // estado
      const [expenses, setExpenses] = useState([]);
      const [installmentPlans, setInstallmentPlans] = useState([]);
      const [filter, setFilter] = useState('Todos');
      const [scope, setScope] = useState('geral');
      const [isAddOpen, setIsAddOpen] = useState(false);
      const [isImportModalOpen, setImportModalOpen] = useState(false);
      const [isImporting, setIsImporting] = useState(false);
      const [isClearModalOpen, setIsClearModalOpen] = useState(false);
      const [importedExpenses, setImportedExpenses] = useState([]);
      const fileInputRef = useRef(null);

      // form adicionar
      const [fDesc, setFDesc] = useState('');
      const [fValor, setFValor] = useState('');
      const [fData, setFData] = useState(() => new Date().toLocaleDateString('pt-PT', { timeZone:'UTC'}));
      const [fTipo, setFTipo] = useState('Cartão');
      const [fSplit, setFSplit] = useState('Dividido');
      const [fFonte, setFFonte] = useState(user === 'Guilherme' ? 'Cartão Guilherme (final 2581)' : 'Cartão Thais (final 1009)');
      const [fParcela, setFParcela] = useState('');
      const [salvando, setSalvando] = useState(false);
      const [editingId, setEditingId] = useState(null);
      const [ajusteValor, setAjusteValor] = useState('');
      const [ajusteDesc, setAjusteDesc]   = useState('');

      // delete
      const [isDelOpen, setDelOpen] = useState(false);
      const [delTarget, setDelTarget] = useState(null);
      const [deleting, setDeleting] = useState(false);

      const openDelete = (exp) => { setDelTarget(exp); setDelOpen(true); };
      const closeDelete = () => { setDelOpen(false); setDelTarget(null); };

      const otherUser = user === 'Guilherme' ? 'Thais' : 'Guilherme';
      const theme = user === 'Thais'
        ? { text:'text-pink-600', darkText:'dark:text-pink-400', bg:'bg-pink-600', hover:'hover:bg-pink-700', border:'border-pink-500' }
        : { text:'text-indigo-600', darkText:'dark:text-indigo-400', bg:'bg-indigo-600', hover:'hover:bg-indigo-700', border:'border-indigo-500' };

      // refs firestore
      const expensesColRef = useMemo(() => db.collection('expenses'), [db]);
      const plansColRef    = useMemo(() => db.collection('installmentPlans'), [db]);

      // streams
      useEffect(() => {
        const unsub1 = expensesColRef.onSnapshot(s => setExpenses(s.docs.map(d => ({ id:d.id, ...d.data()}))));
        const unsub2 = plansColRef.onSnapshot(s => setInstallmentPlans(s.docs.map(d => ({ id:d.id, ...d.data()}))));
        return () => { unsub1(); unsub2(); };
      }, [expensesColRef, plansColRef]);

      // gerar parcelas atrasadas (se existir plano)
      useEffect(() => {
        if (installmentPlans.length === 0) return;
        const today = new Date();
        const batch = db.batch();
        let hasWrites = false;

        for (const plan of installmentPlans) {
          if (!plan.startDate || !plan.numberOfInstallments || !plan.totalAmount) continue;

          const deletedSet = new Set(plan.deletedParcels || []);
          const [dd, mm, yyyy] = String(plan.startDate).split('/');
          const start = new Date(yyyy, mm-1, dd);
          const per = round2(plan.totalAmount / plan.numberOfInstallments);
          const last = round2(plan.totalAmount - per * (plan.numberOfInstallments - 1));

          for (let i=0;i<plan.numberOfInstallments;i++) {
            const d = new Date(start.getFullYear(), start.getMonth()+i, start.getDate(), 12);
            if (d <= today) {
              const num = i+1;
              const parcelaKey = `${num}/${plan.numberOfInstallments}`;
              if (deletedSet.has(parcelaKey)) continue;

              const exists = expenses.some(e => e.installmentPlanId===plan.id && e.parcela===parcelaKey);
              if (!exists) {
                batch.set(expensesColRef.doc(), {
                  installmentPlanId: plan.id,
                  description: plan.description,
                  amount: num === plan.numberOfInstallments ? last : per,
                  date: d.toLocaleDateString('pt-PT', { timeZone:'UTC'}),
                  parcela: parcelaKey,
                  split: plan.split,
                  type: plan.type,
                  paymentSource: plan.paymentSource,
                  paidBy: 'Cartão'
                });
                hasWrites = true;
              }
            }
          }
        }
        if (hasWrites) batch.commit();
      }, [installmentPlans, expenses, db, expensesColRef]);

      /* ===== ações ===== */
      const openEdit = (e) => {
        setEditingId(e.id);
        setFDesc(e.description || '');
        setFValor(String(e.amount ?? '').replace('.', ',')); // campo valor no padrão BR
        setFData(e.date || new Date().toLocaleDateString('pt-PT', { timeZone: 'UTC' }));
        setFTipo(e.type || 'Cartão');
        setFSplit(e.split || 'Dividido');
        setFFonte(
          e.type === 'Cartão'
            ? (e.paymentSource || (user === 'Guilherme' ? 'Cartão Guilherme (final 2581)' : 'Cartão Thais (final 1009)'))
            : e.type
        );
        setFParcela(e.parcela || '');
        setIsAddOpen(true);
      };

      const doDelete = async () => {
        if (!delTarget) return;
        setDeleting(true);
        try {
          const expRef = expensesColRef.doc(delTarget.id);

          if (delTarget.installmentPlanId && delTarget.parcela) {
            // Apaga de vez uma parcela gerada por plano
            const planRef = plansColRef.doc(delTarget.installmentPlanId);
            await db.runTransaction(async (t) => {
              const ps = await t.get(planRef);
              const cur = (ps.data()?.deletedParcels || []);
              const key = String(delTarget.parcela);
              const next = cur.includes(key) ? cur : [...cur, key];
              t.update(planRef, { deletedParcels: next });
              t.delete(expRef);
            });
          } else {
            // Lançamento normal
            await expRef.delete();
          }
          closeDelete();
        } catch (e) {
          console.error(e);
          alert('Falha ao excluir.');
        } finally {
          setDeleting(false);
        }
      };
      
      const normalizeParcelaInput = (s) => {
        let p = String(s || '').trim();
        if (!p) return '';                           // vazio = manter no update
        if (/^\d+\s*\/\s*\d+$/.test(p)) {
          const [a,b] = p.split('/').map(x => Number(x.trim()));
          if (a > 0 && b > 0 && a <= b) return `${a}/${b}`;
          return ''; // inválido
        }
        const m = p.match(/(\d+)\D+(\d+)/);
        if (m) {
          const a = Number(m[1]), b = Number(m[2]);
          if (a > 0 && b > 0 && a <= b) return `${a}/${b}`;
        }
        return '';
      };

      const salvarLancamento = async () => {
        const val = parseMoney(fValor);
        if (!fDesc || !Number.isFinite(val)) { alert('Informe descrição e valor válido.'); return; }

        // valida parcela digitada (se houver)
        const parcelaNorm = normalizeParcelaInput(fParcela);
        if (fParcela && !parcelaNorm) {
          alert('Parcela inválida. Use o formato 2/12.');
          return;
        }

        setSalvando(true);
        try {
          const payloadBase = {
            description: fDesc,
            amount: val,
            date: fData,
            split: fSplit,
            type: fTipo,
            paymentSource: fTipo === 'Cartão' ? fFonte : fTipo,
            paidBy: fTipo === 'Cartão' ? 'Cartão' : user,
          };

          if (editingId) {
            // UPDATE: só altera 'parcela' se o usuário preencheu o campo
            const payload = { ...payloadBase };
            if (fParcela !== '') payload.parcela = parcelaNorm || null; // vazio mantém; "apagar" = limpar
            await expensesColRef.doc(editingId).update(payload);
            setEditingId(null);
          } else {
            // ADD: define parcela (ou null se não informar)
            await expensesColRef.add({ ...payloadBase, parcela: parcelaNorm || null });
          }

          setIsAddOpen(false);
          setFDesc(''); setFValor(''); setFParcela('');
        } catch (e) {
          console.error(e); alert('Falha ao salvar.');
        } finally {
          setSalvando(false);
        }
      };

      const adicionarAjusteRapido = async () => {
        if (user !== 'Thais') { alert('Ajuste só no painel da Thais.'); return; }
        const val = parseMoney(ajusteValor);
        if (!(val > 0)) { alert('Informe um valor POSITIVO para o ajuste.'); return; }

        try {
          await expensesColRef.add({
            description: (ajusteDesc?.trim() || 'Ajuste (Thais → Guilherme)'),
            amount: val,
            date: new Date().toLocaleDateString('pt-PT', { timeZone:'UTC' }),
            split: 'Thais',               // não entra no rateio (tipo Ajuste é ignorado em partsGeral)
            type: 'Ajuste',
            paymentSource: 'Ajuste',
            paidBy: 'Thais',
            parcela: null
          });
          setAjusteValor(''); setAjusteDesc('');
        } catch (e) {
          console.error(e); alert('Falha ao registrar ajuste.');
        }
      };

      const deleteCollection = async (colRef, chunkSize=450) => {
        let snap = await colRef.limit(chunkSize).get();
        while (!snap.empty) {
          const batch = db.batch();
          snap.docs.forEach(d => batch.delete(d.ref));
          await batch.commit();
          snap = await colRef.limit(chunkSize).get();
        }
      };
      const confirmAndClearAll = async () => {
        await deleteCollection(expensesColRef);
        await deleteCollection(plansColRef);
        setIsClearModalOpen(false);
      };

      const exportXLSX = async () => {
        const wb = XLSX.utils.book_new();

        // ===== Aba "Lançamentos" com filtros e colunas ocultas =====
        const toDateObj = (pt) => {
          const m = String(pt || '').match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
          if (!m) return null;
          const dd = Number(m[1]), mm = Number(m[2]) - 1, yyyy = Number(m[3]);
          return new Date(yyyy, mm, dd); // Excel vai reconhecer como data
        };

        const parseParcelaParts = (s) => {
          const m = String(s || '').match(/(\d+)\s*\/\s*(\d+)/);
          return m ? { num: Number(m[1]), tot: Number(m[2]) } : { num: null, tot: null };
        };

        const rows = expenses.map(e => {
          const { num, tot } = parseParcelaParts(e.parcela);
          return {
            Data: toDateObj(e.date) || e.date || '',
            Descrição: e.description || '',
            Valor: Number(e.amount || 0),
            Tipo: e.type || '',
            Divisão: e.split || '',
            Origem: e.paymentSource || '',
            'Pago por': e.paidBy || '',
            Parcela: e.parcela || '',
            'Parcela Nº (oculto)': num,                      // <-- ajuda p/ ordenar
            'Parcela Total (oculto)': tot,                     // <-- ajuda p/ ordenar
            'Parcelado? (ordem oculta)': num != null ? 1 : 0, // 0=normal, 1=parcelado
          };
        });

        // cabeçalhos na ordem desejada
        const headers = [
          'Data','Descrição','Valor','Tipo','Divisão','Origem','Pago por','Parcela',
          'Parcela Nº (oculto)','Parcela Total (oculto)','Parcelado? (ordem oculta)'
        ];

        // cria a planilha (Data como Date real)
        const ws1 = XLSX.utils.json_to_sheet(rows, { header: headers, cellDates: true });

        // formata Valor como moeda
        const range1 = XLSX.utils.decode_range(ws1['!ref'] || 'A1:A1');
        const valorColIndex = headers.indexOf('Valor');
        for (let R = 1; R <= range1.e.r; R++) {
          const addr = XLSX.utils.encode_cell({ r: R, c: valorColIndex });
          const cell = ws1[addr];
          if (cell && typeof cell.v === 'number') { cell.t = 'n'; cell.z = 'R$ #,##0.00'; }
        }

        // formata Data como dd/mm/aaaa
        const dataColIndex = headers.indexOf('Data');
        for (let R = 1; R <= range1.e.r; R++) {
          const addr = XLSX.utils.encode_cell({ r: R, c: dataColIndex });
          const cell = ws1[addr];
          if (cell && cell.v) { cell.z = 'dd/mm/yyyy'; }
        }

        // aplica AutoFilter no intervalo inteiro (cabeçalho + dados)
        ws1['!autofilter'] = { ref: XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: range1.e.r, c: headers.length - 1 } }) };

        // larguras e ocultação de colunas
        ws1['!cols'] = [
          { wch: 12 }, // Data
          { wch: 42 }, // Descrição
          { wch: 12 }, // Valor
          { wch: 10 }, // Tipo
          { wch: 12 }, // Divisão
          { wch: 28 }, // Origem
          { wch: 12 }, // Pago por
          { wch: 10 }, // Parcela
          { hidden: true }, // Parcela Nº (oculto)
          { hidden: true }, // Parcela Total (oculto)
          { hidden: true }, // Parcelado? (ordem oculta)
        ];

        XLSX.utils.book_append_sheet(wb, ws1, 'Lancamentos');


        // resumo (usa memos mais abaixo)
        const resumo = [
          ['Usuário', user],
          ['Escopo exibido', scope],
          ['Parte do Guilherme (escopo)', partsScoped.g],
          ['Parte da Thais (escopo)',      partsScoped.t],
          ['Dif. de gastos (escopo)', difGastos],
          ['Se eu quitar tudo (escopo), recebo de ' + otherUser, valorDevolverSePagarTudo],
          [],
          ['Cartões - Total (geral)', cardTotals.grandTotal],
          ['Cartão Guilherme 2581', cardTotals.guilhermeCardTotal],
          ['Cartão Thais 1009', cardTotals.thaisCardTotal],
          ['Cartão Digital 7292', cardTotals.digitalCardTotal],
          [],
          ['Pagamentos feitos por Guilherme (Pix/Boleto/Ajuste)', gPaid],
          ['Pagamentos feitos por Thais (Pix/Boleto/Ajuste)', tPaid],
          ['Saldo real para ' + user, saldoUsuario],
        ];
        const ws2 = XLSX.utils.aoa_to_sheet(resumo);
        [3,4,5,6,8,9,10,11,13,14,15].forEach(r => {
          const addr = `B${r}`; if (ws2[addr]) { ws2[addr].t='n'; ws2[addr].z='R$ #,##0.00'; }
        });
        XLSX.utils.book_append_sheet(wb, ws2, 'Resumo');

        const filename = `meu-acerto-${user.toLowerCase()}-${new Date().toISOString().slice(0,10)}.xlsx`;
        
        try {
          // 1) Download direto (mais compatível em PWA/Android/iOS/desktop)
          if (XLSX && XLSX.writeFileXLSX) {
            XLSX.writeFileXLSX(wb, filename);
          } else {
            XLSX.writeFile(wb, filename);
          }
          return; // sucesso
        } catch (err) {
          console.warn('writeFile falhou, tentando ObjectURL:', err);
        }

        try {
          // 2) Fallback final: ObjectURL
          const wbArray = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
          const blob = new Blob([wbArray], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = filename; a.rel = 'noopener';
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
        } catch (finalErr) {
          console.error('Export error:', finalErr);
          alert('Falha ao exportar.'); // só aparece se TUDO falhar
        }
      };

      // importar CSV/XLSX
      const handleFileUpload = async (event) => {
        try {
          const file = event.target.files?.[0]; if (!file) return;
          const isCSV = file.type === 'text/csv' || file.name.toLowerCase().endsWith('.csv');
          const readFile = () => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            if (isCSV) reader.readAsText(file, 'utf-8'); else reader.readAsArrayBuffer(file);
          });

          const data = await readFile();
          const wb = isCSV ? XLSX.read(data, {type:'string'}) : XLSX.read(data, {type:'array'});
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { defval:'' });

          const headerNorm = (h) => norm(String(h)).replace(/\s+/g,'').replace(/[^a-z0-9]/g,'');
          const pick = (row, keys) => {
            for (const k of Object.keys(row)) if (keys.includes(headerNorm(k))) return row[k];
            return '';
          };

          const mapped = rows.map(row => {
            const desc = pick(row,['descricao','description','descrição']);
            const rawAmount = pick(row,['valor','amount','preco','preço','price']);
            const rawDate = pick(row,['data','date']);
            const rawType = pick(row,['tipo','type']);
            const rawSource = pick(row,['origem','fonte','paymentsource','source']);
            const rawParcela = pick(row,['parcela','installment']);
            const rawSplit = pick(row,['split','divisao','divisão']);
            const rawPaidBy = pick(row,['paidby','pagopor']);

            const t = norm(rawType);
            const type = t.includes('ajuste') ? 'Ajuste' : t.includes('pix') ? 'Pix' : t.includes('boleto') ? 'Boleto' : 'Cartão';

            const amount = parseMoney(String(rawAmount));
            if (!Number.isFinite(amount) || !desc) return null;

            const date = excelSerialToPT(rawDate);
            const srcN = norm(rawSource);
            const paymentSource = type === 'Cartão'
              ? (srcN.includes('7292') || srcN.includes('digital') || /virt/.test(srcN)
                  ? 'Cartão Digital (final 7292)'
                  : (rawSource || (user==='Guilherme' ? 'Cartão Guilherme (final 2581)' : 'Cartão Thais (final 1009)')))
              : type;

            const split = canonicalSplit(rawSplit);
            const paidNorm = norm(rawPaidBy);
            const paidBy = type === 'Cartão' ? 'Cartão' :
              paidNorm.includes('thais') ? 'Thais' :
              paidNorm.includes('guilherme') ? 'Guilherme' : user;

            let parcela = String(rawParcela||'').trim();
            if (parcela && !/^\d+\/\d+$/.test(parcela)) {
              const m = parcela.match(/(\d+)\D+(\d+)/);
              parcela = m ? `${m[1]}/${m[2]}` : '';
            }
            if (!parcela) parcela = null;

            return { description: desc, amount, date, split, paidBy, paymentSource, type, parcela };
          }).filter(Boolean);

          if (mapped.length === 0) { alert('Não encontrei linhas válidas para importar.'); return; }
          setImportedExpenses(mapped);
          setImportModalOpen(true);
        } catch (e) {
          console.error('Erro no upload:', e); alert('Falha ao carregar ficheiro.');
        } finally {
          event.target.value = '';
        }
      };

      const confirmImport = async () => {
        if (isImporting) return;
        setIsImporting(true);
        try {
          const unique = importedExpenses.filter(imp =>
            !expenses.some(ex =>
              ex.description === imp.description &&
              Math.abs(ex.amount - imp.amount) < 0.01 &&
              ex.date === imp.date &&
              ex.parcela === imp.parcela &&
              ex.paymentSource === imp.paymentSource &&
              ex.type === imp.type &&
              canonicalSplit(ex.split) === canonicalSplit(imp.split)
            )
          );
          const chunkSize = 450;
          for (let i=0;i<unique.length;i+=chunkSize) {
            const chunk = unique.slice(i,i+chunkSize);
            const batch = db.batch();
            chunk.forEach(e => batch.set(expensesColRef.doc(), e));
            await batch.commit();
          }
          setImportedExpenses([]); setImportModalOpen(false);
        } catch (e) { console.error(e); alert('Falha ao importar.'); }
        finally { setIsImporting(false); }
      };

      /* ===== cálculos/memos ===== */
      const filteredAndSortedExpenses = useMemo(() => {
        const toDate = d => d ? new Date(d.split('/').reverse().join('-')) : new Date(0);
        const userVisible = expenses.filter(e => {
          if (e.type === 'Cartão') {
            const src = e.paymentSource || '';
            if (src.includes('7292')) return true; // digital visível p/ ambos
            return user === 'Guilherme' ? src.includes('2581') : src.includes('1009');
          }
           if (e.type === 'Ajuste' && e.paidBy === 'Thais') return true;
          return e.paidBy === user;
        });

        let filtered = userVisible;
        switch (filter) {
          case 'Cartão':     filtered = userVisible.filter(e => e.type==='Cartão' && !e.parcela); break;
          case 'Parcelados': filtered = userVisible.filter(e => !!e.parcela); break;
          case 'Pix':        filtered = userVisible.filter(e => e.type==='Pix'); break;
          case 'Boleto':     filtered = userVisible.filter(e => e.type==='Boleto'); break;
          case 'Ajustes':
            filtered = userVisible.filter(e => e.type === 'Ajuste');
            break;
          default:           filtered = userVisible;
        }

        return filtered.sort((a,b) => {
          const ad = toDate(a.date), bd = toDate(b.date);
          if (filter==='Todos') {
            const ap = !!a.parcela, bp = !!b.parcela;
            if (ap !== bp) return ap ? 1 : -1; // não-parcelados primeiro
          }
          return bd - ad;
        });
      }, [expenses, filter, user]);

      const cardTotals = useMemo(() => {
        const sum = (needle) => round2(expenses.filter(e => e.type==='Cartão' && (e.paymentSource||'').includes(needle))
          .reduce((s,e)=>s+Number(e.amount||0),0));
        const t2581 = sum('2581'), t1009 = sum('1009'), t7292 = sum('7292');
        return { guilhermeCardTotal:t2581, thaisCardTotal:t1009, digitalCardTotal:t7292, grandTotal: round2(t2581+t1009+t7292) };
      }, [expenses]);

      const partsScoped = useMemo(() => {
        let g=0, t=0;
        const base = expenses.filter(e => e.type!=='Ajuste');
        const src = scope==='geral' ? base : scope==='cartao' ? base.filter(e=>e.type==='Cartão') : base.filter(e=>e.type==='Pix'||e.type==='Boleto');
        for (const e of src) {
          const v = Number(e.amount||0), s = canonicalSplit(e.split);
          if (s==='Dividido') { g+=v/2; t+=v/2; }
          else if (s==='Guilherme') g+=v;
          else if (s==='Thais') t+=v;
        }
        return { g:round2(g), t:round2(t) };
      }, [expenses, scope]);

      const partsPagos = useMemo(() => {
        let g=0, t=0;
        const src = expenses.filter(e => e.type==='Pix' || e.type==='Boleto');
        for (const e of src) {
          const v = Number(e.amount||0), s = canonicalSplit(e.split);
          if (s==='Dividido') { g+=v/2; t+=v/2; }
          else if (s==='Guilherme') g+=v;
          else if (s==='Thais') t+=v;
        }
        return { g:round2(g), t:round2(t) };
      }, [expenses]);

      const { gPaid, tPaid } = useMemo(() => {
        let g=0, t=0;
        const reals = expenses.filter(e => e.type==='Pix' || e.type==='Boleto' || e.type==='Ajuste');
        for (const e of reals) {
          const v = Number(e.amount||0);
          if (e.paidBy==='Guilherme' || e.paidBy==='Digital') g+=v;
          else if (e.paidBy==='Thais') t+=v;
        }
        return { gPaid:round2(g), tPaid:round2(t) };
      }, [expenses]);

      // (a) Responsabilidade total de cada um no GERAL (Cartão + Pix + Boleto), sem Ajuste
      const partsGeral = useMemo(() => {
        let g = 0, t = 0;
        const base = expenses.filter(e => e.type !== 'Ajuste');
        for (const e of base) {
          const v = Number(e.amount || 0);
          const s = canonicalSplit(e.split);
          if (s === 'Dividido') { g += v/2; t += v/2; }
          else if (s === 'Guilherme') g += v;
          else if (s === 'Thais') t += v;
        }
        return { g: round2(g), t: round2(t) };
      }, [expenses]);

      // (b) O que a Thais já pagou em Pix/Boleto (dinheiro real que saiu dela)
      const paidPBThais = useMemo(() => round2(
        expenses
          .filter(e => e.type === 'Pix' || e.type === 'Boleto')
          .filter(e => e.paidBy === 'Thais')
          .reduce((s, e) => s + Number(e.amount || 0), 0)
      ), [expenses]);

      // (c) Ajustes que a Thais já te pagou (só Thais lança, valor > 0)
      const ajustesThais = useMemo(() => round2(
        expenses
          .filter(e => e.type === 'Ajuste' && e.paidBy === 'Thais')
          .reduce((s, e) => s + Number(e.amount || 0), 0)
      ), [expenses]);

      // (d) Saldo devedor da Thais com o Guilherme = tudo que é parte da Thais - (o que ela já pagou em Pix/Boleto) - (o que ela já te devolveu em Ajuste)
      const saldoDevedorThais = useMemo(() => {
        const raw = (partsGeral.t - paidPBThais - ajustesThais);
        return round2(raw);
      }, [partsGeral, paidPBThais, ajustesThais]);


      const minhaParteFatura = user==='Guilherme' ? partsScoped.g : partsScoped.t;
      const parteDoOutroFatura = user==='Guilherme' ? partsScoped.t : partsScoped.g;
      const valorDevolverSePagarTudo = parteDoOutroFatura;
      const difGastos = round2(Math.abs(partsScoped.g - partsScoped.t));
      const quemGastouMaisLabel = (() => {
        if (difGastos < 0.01) return 'Gastos empatados';
        const quem = partsScoped.g > partsScoped.t ? 'Guilherme' : 'Thais';
        return user === quem ? 'Você gastou a mais' : `${quem} gastou a mais`;
      })();

      const labelQuitarTudo = scope==='cartao'
        ? `Se você pagar a fatura por inteiro, ${otherUser} te devolve:`
        : `Se você quitar tudo deste filtro, ${otherUser} te devolve:`;

      const gBalance = round2(gPaid - partsPagos.g);
      const saldoUsuario = user==='Guilherme' ? gBalance : -gBalance;
      const { saldoLabel, saldoCor } = (() => {
        if (Math.abs(saldoUsuario) < 0.01) return { saldoLabel:'Saldo zerado!', saldoCor:'text-emerald-500' };
        return saldoUsuario > 0
          ? { saldoLabel:`Você tem a receber de ${otherUser}`, saldoCor:'text-emerald-500' }
          : { saldoLabel:`Você deve para ${otherUser}`,   saldoCor:'text-amber-500'  };
      })();

      /* ===== UI ===== */
      return (
        <div className="max-w-4xl mx-auto p-2 sm:p-4 pb-24">
          <header className="relative mb-6">
            <div>
              <h1 className="text-3xl font-extrabold">Olá, {user}</h1>
              <p className="text-slate-500 dark:text-slate-400">Resumo das suas despesas.</p>
            </div>
            <button onClick={onLogout}
              className="absolute top-0 right-0 p-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600"
              aria-label="Trocar de usuário" title="Trocar de usuário">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path d="M10 6H6a2 2_0 0 0-2 2v8a2 2 0 0 0 2 2h4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M14 16l4-4-4-4M8 12h10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
              </svg>
            </button>
          </header>

          <div className="grid gap-4 md:grid-cols-2 mb-6">
            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md space-y-3">
              <h3 className="font-semibold text-slate-600 dark:text-slate-400">Total das faturas (cartões)</h3>
              <p className="text-3xl font-extrabold">{formatBRL(cardTotals.grandTotal)}</p>
              <div className="text-xs space-y-1">
                <p>Guilherme 2581: <span className="font-semibold">{formatBRL(cardTotals.guilhermeCardTotal)}</span></p>
                <p>Thais 1009: <span className="font-semibold">{formatBRL(cardTotals.thaisCardTotal)}</span></p>
                <p>Digital 7292: <span className="font-semibold">{formatBRL(cardTotals.digitalCardTotal)}</span></p>
              </div>
            </div>

            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md space-y-3">
              <h3 className="font-semibold text-slate-600 dark:text-slate-400">Saldo de Acerto (Filtro)</h3>
               <p className="text-slate-500 dark:text-slate-400">{saldoLabel}</p>
              <p className={`${saldoCor} text-3xl font-extrabold`}>{formatBRL(saldoUsuario)}</p>
              <hr className="border-slate-200 dark:border-slate-700" />
              <div className="text-sm">
                 <p>Pagamentos (Pix/Boleto/Ajuste) por você: <span className="font-semibold">{formatBRL(user === 'Guilherme' ? gPaid : tPaid)}</span></p>
                <p>Pagamentos por {otherUser}: <span className="font-semibold">{formatBRL(user === 'Guilherme' ? tPaid : gPaid)}</span></p>
              </div>
               <button onClick={exportXLSX}
                className={`w-full mt-2 px-4 py-2 rounded-lg font-semibold text-white ${theme.bg} ${theme.hover}`}>
                Exportar Relatório
              </button>
            </div>
          </div>
          
          {user === 'Guilherme' && (
            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md space-y-3 mb-6">
              <div className="flex items-center justify-between gap-4">
                <div>
                  <h3 className="font-semibold text-slate-600 dark:text-slate-400">
                    Ajustes (Thais → Guilherme) — visualização
                  </h3>
                  <p className="text-xs text-slate-500 dark:text-slate-400">
                    Quanto falta a Thais te devolver (geral) e quanto já depositou em Ajustes.
                  </p>
                </div>
                <div className="text-right">
                  <p className="text-sm text-slate-500 dark:text-slate-400">A receber de Thais (geral)</p>
                  <p className={`text-2xl font-extrabold ${saldoDevedorThais > 0 ? 'text-emerald-600' : 'text-slate-500'}`}>
                    {formatBRL(Math.max(0, saldoDevedorThais))}
                  </p>
                  {saldoDevedorThais < 0 && (
                    <p className="text-xs text-emerald-600">
                      Você já recebeu {formatBRL(Math.abs(saldoDevedorThais))} além do devido.
                    </p>
                  )}
                </div>
              </div>

              <div className="text-xs text-slate-600 dark:text-slate-300">
                Devido pela Thais (geral): <span className="font-semibold">{formatBRL(partsGeral.t)}</span> •
                Pago por Thais (Pix/Boleto): <span className="font-semibold">{formatBRL(paidPBThais)}</span> •
                Ajustes já pagos: <span className="font-semibold">{formatBRL(ajustesThais)}</span>
              </div>
            </div>
          )}

          {user === 'Thais' && (
            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md space-y-4 mb-6">
              <div className="flex items-center justify-between gap-4">
                <div>
                  <h3 className="font-semibold text-slate-600 dark:text-slate-400">Ajustes (Thais → Guilherme)</h3>
                  <p className="text-xs text-slate-500 dark:text-slate-400">
                    Lançe aqui os valores que você pagou ao Guilherme. Isso reduz seu saldo devedor geral.
                  </p>
                </div>
                <div className="text-right">
                  <p className="text-sm text-slate-500 dark:text-slate-400">Saldo devedor (geral)</p>
                  <p className={`text-2xl font-extrabold ${saldoDevedorThais > 0 ? 'text-amber-500' : 'text-emerald-500'}`}>
                    {formatBRL(saldoDevedorThais)}
                  </p>
                  <p className="text-xs text-slate-500 dark:text-slate-400">
                    Já pago em ajustes: <span className="font-semibold">{formatBRL(ajustesThais)}</span>
                  </p>
                </div>
              </div>

              <div className="grid gap-2 sm:grid-cols-[160px_1fr_auto]">
                <input
                  className="px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 outline-none"
                  placeholder="Valor (ex: 200,00)"
                  inputMode="decimal"
                  value={ajusteValor}
                  onChange={(e)=>setAjusteValor(e.target.value)}
                />
                <input
                  className="px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 outline-none"
                  placeholder="Descrição (opcional)"
                  value={ajusteDesc}
                  onChange={(e)=>setAjusteDesc(e.target.value)}
                />
                <button
                  onClick={adicionarAjusteRapido}
                  className="px-4 py-2 rounded-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700"
                >
                  Registrar ajuste
                </button>
              </div>

              <div className="text-xs text-slate-500 dark:text-slate-400">
                Sua parte total (geral): <span className="font-semibold">{formatBRL(partsGeral.t)}</span> •
                Pagos por você (Pix/Boleto): <span className="font-semibold">{formatBRL(paidPBThais)}</span>
              </div>
            </div>
          )}

          <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md space-y-4 mb-6">
            <h3 className="font-semibold text-slate-600 dark:text-slate-400">Resumo da Fatura (Gastos)</h3>
            <div className="flex flex-wrap gap-2">
              <button onClick={()=>setScope('geral')}
                className={`px-3 py-1.5 rounded-full text-sm font-semibold transition ${scope==='geral' ? `${theme.bg} text-white shadow` : 'bg-slate-200 dark:bg-slate-700 hover:bg-slate-300'}`}>Geral</button>
              <button onClick={()=>setScope('cartao')}
                className={`px-3 py-1.5 rounded-full text-sm font-semibold transition ${scope==='cartao' ? `${theme.bg} text-white shadow` : 'bg-slate-200 dark:bg-slate-700 hover:bg-slate-300'}`}>Só Cartões</button>
              <button onClick={()=>setScope('pixboleto')}
                className={`px-3 py-1.5 rounded-full text-sm font-semibold transition ${scope==='pixboleto' ? `${theme.bg} text-white shadow` : 'bg-slate-200 dark:bg-slate-700 hover:bg-slate-300'}`}>Pix e Boletos</button>
            </div>
            <div>
              <p className="text-slate-500 dark:text-slate-400 mb-1">{labelQuitarTudo}</p>
              <p className={`${theme.text} ${theme.darkText} text-3xl font-extrabold`}>{formatBRL(valorDevolverSePagarTudo)}</p>
            </div>
            <hr className="border-slate-200 dark:border-slate-700" />
            <div>
              <p className="font-semibold text-slate-600 dark:text-slate-400">{quemGastouMaisLabel}</p>
              <p className="text-sky-400 text-2xl font-bold">{formatBRL(difGastos)}</p>
            </div>
            <div>
              <p>Sua parte na fatura: <span className="font-semibold">{formatBRL(minhaParteFatura)}</span></p>
              <p>Parte de {otherUser}: <span className="font-semibold">{formatBRL(parteDoOutroFatura)}</span></p>
            </div>
          </div>

          <div className="flex gap-2 mb-6">
            <button onClick={()=>setIsAddOpen(true)}
              className={`flex-1 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition ${theme.bg} ${theme.hover}`}>
              Adicionar
            </button>
            <button onClick={()=>fileInputRef.current?.click()}
              className="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-semibold py-3 px-4 rounded-xl shadow-lg hover:bg-slate-300 dark:hover:bg-slate-600">
              Importar
            </button>
            <input ref={fileInputRef} type="file" className="hidden" accept=".csv,.xlsx,.xls" onChange={handleFileUpload} />
            <button onClick={()=>setIsClearModalOpen(true)}
              className="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg">
              Limpar
            </button>
          </div>

          <div className="bg-white dark:bg-slate-800 p-2 sm:p-4 rounded-2xl shadow-md">
            <div className="flex flex-wrap gap-2 mb-3">
              {['Todos','Cartão','Parcelados','Pix','Boleto','Ajustes'].map(opt => (
                <button key={opt} onClick={()=>setFilter(opt)}
                  className={`px-3 py-1.5 rounded-full text-sm font-semibold transition ${
                    filter===opt ? `${theme.bg} text-white shadow` : 'bg-slate-200 dark:bg-slate-700 hover:bg-slate-300'
                  }`}>
                  {opt}
                </button>
              ))}
            </div>
            <div className="space-y-2">
              {filteredAndSortedExpenses.map(expense => {
                const splitCan = canonicalSplit(expense.split);
                return (
                  <div
                    key={expense.id}
                    className={`grid grid-cols-[minmax(0,1fr)_auto] items-center gap-2 p-2
                                rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 border-l-4 transition-all ${
                      splitCan==='Guilherme' ? 'border-indigo-500'
                        : splitCan==='Thais' ? 'border-pink-500'
                        : 'border-transparent'
                    }`}
                  >
                    {/* COLUNA ESQUERDA (texto) */}
                    <div className="min-w-0">
                      <p className="font-semibold truncate">{expense.description}</p>
                      <p className="text-xs text-slate-500 dark:text-slate-400 truncate">
                        {expense.date} {expense.parcela ? `• ${expense.parcela}` : ''} • {expense.type}
                      </p>
                    </div>

                    {/* COLUNA DIREITA (valor + ícones SEM QUEBRAR) */}
                    <div className="flex items-center justify-end gap-1 sm:gap-2 whitespace-nowrap">
                      {/* chips continuam escondidos no mobile */}
                      {expense.type !== 'Cartão' && (
                        <span className="hidden sm:inline text-[10px] sm:text-xs px-2 py-0.5 rounded-full bg-slate-200 dark:bg-slate-600">
                          Pago por: {expense.paidBy}
                        </span>
                      )}
                      {expense.type === 'Cartão' && (
                        <span className="hidden sm:inline text-[10px] sm:text-xs px-2 py-0.5 rounded-full bg-slate-200 dark:bg-slate-600">
                          {(expense.paymentSource||'').includes('7292') ? 'Cartão Digital' : (expense.paymentSource || 'Cartão')}
                        </span>
                      )}

                      {/* valor */}
                      <p className={`font-semibold text-base sm:text-lg ${expense.amount < 0 ? 'text-emerald-500' : ''}`}>
                        {formatBRL(expense.amount)}
                      </p>

                      {/* editar */}
                      <button
                        onClick={() => openEdit(expense)}
                        className="p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 ml-1 sm:ml-2"
                        aria-label="Editar lançamento" title="Editar lançamento"
                      >
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                          <path d="M12 20h9" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
                          <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5Z"
                                stroke="currentColor" strokeWidth="2" strokeLinejoin="round"/>
                        </svg>
                      </button>

                      {/* lixeira */}
                      <button
                        onClick={(e)=>{ e.stopPropagation(); openDelete(expense); }}
                        className="p-1.5 rounded hover:bg-red-500/10"
                        aria-label="Excluir lançamento"
                        title="Excluir"
                      >
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                          <path d="M3 6h18" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
                          <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" strokeWidth="2"/>
                          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" stroke="currentColor" strokeWidth="2"/>
                          <path d="M10 11v6M14 11v6" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                );
              })}
              {filteredAndSortedExpenses.length===0 && (
                <div className="p-4 text-sm text-slate-500 dark:text-slate-400">Sem lançamentos neste filtro.</div>
              )}
            </div>
          </div>

          <Modal isOpen={isAddOpen} onClose={()=>setIsAddOpen(false)}>
            <div className="p-5 space-y-3">
              <h2 id="modal-title" className="text-lg font-semibold">
                {editingId ? 'Editar lançamento' : 'Novo lançamento'}
              </h2>
              <input className="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 outline-none" placeholder="Descrição" value={fDesc} onChange={e=>setFDesc(e.target.value)} />
              <input className="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 outline-none" placeholder="Valor (ex: 123,45)" inputMode="decimal" value={fValor} onChange={e=>setFValor(e.target.value)} />
              <input className="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 outline-none" placeholder="dd/mm/aaaa" value={fData} onChange={e=>setFData(e.target.value)} />
              
              {fTipo === 'Cartão' && (
                <input
                  className="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 outline-none"
                  placeholder="Parcela (ex: 2/12) — deixe em branco p/ manter"
                  value={fParcela}
                  onChange={e => setFParcela(e.target.value)}
                />
              )}

              <div className="flex gap-2">
                <select className="flex-1 px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 outline-none" value={fTipo} onChange={e=>setFTipo(e.target.value)}>
                  <option>Cartão</option><option>Pix</option><option>Boleto</option><option>Ajuste</option>
                </select>
                <select className="flex-1 px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 outline-none" value={fSplit} onChange={e=>setFSplit(e.target.value)}>
                  <option>Dividido</option><option>Guilherme</option><option>Thais</option>
                </select>
              </div>
              {fTipo==='Cartão' && (
                <select className="w-full px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 outline-none" value={fFonte} onChange={e=>setFFonte(e.target.value)}>
                  <option>Cartão Guilherme (final 2581)</option>
                  <option>Cartão Thais (final 1009)</option>
                  <option>Cartão Digital (final 7292)</option>
                </select>
              )}
              <div className="flex justify-end gap-2 pt-2">
                <button
                  onClick={() => { setIsAddOpen(false); setEditingId(null); setFParcela(''); }}
                  className="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700"
                >
                  Cancelar
                </button>
                <button
                  onClick={salvarLancamento}
                  disabled={salvando}
                  className={`px-4 py-2 rounded-lg text-white ${theme.bg} ${theme.hover}`}
                >
                  {salvando ? (editingId ? 'Atualizando...' : 'Salvando...') : (editingId ? 'Atualizar' : 'Salvar')}
                </button>
              </div>
            </div>
          </Modal>

          <Modal isOpen={isImportModalOpen} onClose={()=>setImportModalOpen(false)}>
            <div className="p-5">
              <h2 id="modal-title" className="text-lg font-semibold mb-2">Confirmar importação</h2>
              <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">Encontrados <b>{importedExpenses.length}</b> lançamentos válidos. Deseja importar agora?</p>
              <div className="flex gap-2 justify-end">
                <button onClick={()=>setImportModalOpen(false)} className="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700">Cancelar</button>
                <button onClick={confirmImport} className={`px-4 py-2 rounded-lg text-white ${theme.bg} ${theme.hover}`} disabled={isImporting}>{isImporting ? 'Importando...' : 'Importar'}</button>
              </div>
            </div>
          </Modal>

          <Modal isOpen={isClearModalOpen} onClose={()=>setIsClearModalOpen(false)}>
            <div className="p-5">
              <h2 id="modal-title" className="text-lg font-semibold mb-2 text-red-600">Apagar tudo?</h2>
              <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">Isso irá apagar todas as despesas e planos de parcelamento. Esta ação não pode ser desfeita.</p>
              <div className="flex gap-2 justify-end">
                <button onClick={()=>setIsClearModalOpen(false)} className="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700">Cancelar</button>
                <button onClick={confirmAndClearAll} className="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white">Apagar</button>
              </div>
            </div>
          </Modal>

          <Modal isOpen={isDelOpen} onClose={closeDelete}>
            <div className="p-5">
              <h2 id="modal-title" className="text-lg font-semibold mb-2 text-red-600">
                Excluir lançamento?
              </h2>
              <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">
                {delTarget?.description} — {delTarget ? formatBRL(delTarget.amount) : ''}
              </p>

              {delTarget?.installmentPlanId && delTarget?.parcela && (
                <div className="text-xs mb-4 p-2 rounded bg-amber-100/60 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300">
                  Este lançamento é <b>parcela ({delTarget.parcela})</b> de um plano. Ele não será recriado novamente.
                </div>
              )}

              <div className="flex gap-2 justify-end">
                <button onClick={closeDelete} className="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700">
                  Cancelar
                </button>
                <button onClick={doDelete} disabled={deleting}
                  className="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white">
                  {deleting ? 'Excluindo...' : 'Excluir'}
                </button>
              </div>
            </div>
          </Modal>
        </div>
      );
    };

    /* ================= App (Firebase + Shell) ================= */
    const App = () => {
      const [currentUser, setCurrentUser] = useState(() => JSON.parse(localStorage.getItem('meuAcertoUser') || 'null'));
      const [db, setDb] = useState(null);
      const [authReady, setAuthReady] = useState(false);
      const [error, setError] = useState(null);

      useEffect(() => {
        const firebaseConfig = {
          apiKey: "AIzaSyCeecZ8a4rPnf26IItU-HaaeRpcv5xPTkk",
          authDomain: "meu-acerto-app.firebaseapp.com",
          projectId: "meu-acerto-app",
          storageBucket: "meu-acerto-app.appspot.com",
          messagingSenderId: "326844075367",
          appId: "1-326844075367-web-0315e86713b1e0071f33c2"
        };
        try {
          if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
          const firestoreDb = firebase.firestore();
          firestoreDb.enablePersistence({ synchronizeTabs: true }).catch(()=>{});
          setDb(firestoreDb);

          const auth = firebase.auth();
          const unsub = auth.onAuthStateChanged(u => setAuthReady(!!u));
          (async () => {
            try {
              await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
              await auth.signInAnonymously();
            } catch (err) {
              console.error("Auth error:", err);
              setError(`Erro de autenticação: ${err.message}.`);
            }
          })();
          return () => unsub();
        } catch (err) {
          console.error("Failed to initialize Firebase:", err);
          setError("Falha ao inicializar o Firebase.");
        }
      }, []);

      const handleSelectUser = (u) => { setCurrentUser(u); localStorage.setItem('meuAcertoUser', JSON.stringify(u)); };
      const handleLogout = () => { setCurrentUser(null); localStorage.removeItem('meuAcertoUser'); };

      if (error) return <div className="min-h-screen flex items-center justify-center text-red-500 font-semibold p-4 text-center">{error}</div>;
      if (!db || !authReady) return <div className="min-h-screen flex items-center justify-center text-slate-500">A ligar ao servidor…</div>;
      if (!currentUser) return <UserSelectionScreen onSelectUser={handleSelectUser} />;

      return <Dashboard user={currentUser} onLogout={handleLogout} db={db} />;
    };

    // mount + SW
    window.onload = () => {
      createRoot(document.getElementById('root')).render(<App />);
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(()=>{});
      }
    };
  </script>
</body>
</html>

