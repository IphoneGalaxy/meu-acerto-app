<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meu Acerto</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Meu Acerto" />
  <link rel="apple-touch-icon" href="https://placehold.co/180x180/4338ca/ffffff?text=Acerto" />

  <!-- Theme Colors -->
  <meta name="theme-color" content="#f8fafc" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'media' }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase Modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { 
      getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, 
      onSnapshot, runTransaction, writeBatch, query, where, getDocs, 
      enableIndexedDbPersistence, orderBy, limit, startAfter, documentId 
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { 
      getAuth, signInAnonymously, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    window.FirebaseLib = {
      initializeApp, getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
      onSnapshot, runTransaction, writeBatch, query, where, getDocs, enableIndexedDbPersistence,
      orderBy, limit, startAfter, documentId,
      getAuth, signInAnonymously, onAuthStateChanged
    };
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .modal-enter { animation: fadeIn .2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(.98);} to { opacity: 1; transform: scale(1);} }
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useMemo, useRef } = React;
    const { createRoot } = ReactDOM;

    /* ========= Styles Object ========= */
    const ui = {
      modal: "bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 rounded-2xl shadow-xl p-6 max-w-md w-full m-4",
      label: "block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1",
      input: "w-full rounded-xl border px-4 py-3 text-sm bg-white text-slate-900 placeholder-slate-400 " +
             "border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 " +
             "dark:bg-slate-800 dark:text-slate-100 dark:placeholder-slate-500 dark:border-slate-700",
      select: "w-full rounded-xl border px-4 py-3 text-sm bg-white text-slate-900 " +
              "border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 " +
              "dark:bg-slate-800 dark:text-slate-100 dark:border-slate-700",
      btnPrimary: "rounded-xl px-5 py-3 bg-pink-600 hover:bg-pink-700 text-white font-semibold shadow-md hover:shadow-lg transition-all " +
                  "dark:bg-pink-600 dark:hover:bg-pink-500",
      btnGhost: "rounded-xl px-4 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 " +
                "dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-800 transition-colors"
    };

    /* ========= Helpers ========= */
    const norm = (s) => 
      String(s || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim()
        .toLowerCase();

    const canonicalSplit = (s) => {
      const n = norm(s);
      if (n.includes('guilherme')) return 'Guilherme';
      if (n.includes('thais')) return 'Thais';
      return 'Dividido';
    };

    // --- Dono Exclusivo ---
    const uiOwner = (e) => {
      const s = norm(e.split);
      if (s === "guilherme" || s === "thais") return s;
      const who = norm(e.paidBy || e.owner || e.user || e.person || e.responsavel);
      if (who === "guilherme" || who === "thais") return who;
      return "dividido";
    };

    // --- Faixa Lateral Estilo "Pílula" (Com Respiro) ---
    const stripeBySplit = (e) => {
      const owner = uiOwner(e);
      // Base da pílula: absoluta, esquerda 0, com respiro top/bottom e arredondada
      const base = "before:content-[''] before:absolute before:left-0 before:top-2 before:bottom-2 before:w-1.5 before:rounded-full";
      
      if (owner === "guilherme") return base + " before:bg-indigo-500";
      if (owner === "thais")     return base + " before:bg-pink-500";
      return ""; // Sem faixa para divididos
    };

    const parseMoney = (input) => {
      if (typeof input === 'number') return input;
      if (input == null || input === '') return NaN;
      let s = String(input).replace(/\s+/g, '').trim();
      const parenNeg = /^\(.*\)$/.test(s);
      const trailingNeg = /-$/.test(s);
      if (parenNeg) s = s.replace(/[()]/g, '');
      if (trailingNeg) s = s.slice(0, -1);
      const negativeSign = parenNeg || trailingNeg;
      const leadingNegative = s.startsWith('-');
      if (leadingNegative) s = s.slice(1);
      let n;
      const hasComma = s.includes(',');
      const hasDot = s.includes('.');
      if (hasComma && !hasDot) n = parseFloat(s.replace(',', '.'));
      else if (hasDot && !hasComma) {
        if (s.indexOf('.') === s.lastIndexOf('.') && s.length - s.indexOf('.') <= 3) n = parseFloat(s);
        else n = parseFloat(s.replace(/\./g, ''));
      } else if (hasComma && hasDot) {
        const lastComma = s.lastIndexOf(',');
        const lastDot = s.lastIndexOf('.');
        if (lastComma > lastDot) n = parseFloat(s.replace(/\./g, '').replace(',', '.'));
        else n = parseFloat(s.replace(/,/g, ''));
      } else { n = parseFloat(s); }
      return Number.isFinite(n) ? ((negativeSign || leadingNegative) ? -n : n) : NaN;
    };

    const excelSerialToPT = (v) => {
      if (typeof v === 'number') {
        const ms = Math.round((v - 25569) * 86400 * 1000);
        return new Date(ms).toLocaleDateString('pt-PT', { timeZone: 'UTC' });
      }
      if (typeof v === 'string') {
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) return v;
        if (/^\d{4}-\d{2}-\d{2}/.test(v)) return new Date(v).toLocaleDateString('pt-PT', { timeZone: 'UTC' });
        const m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})$/);
        if (m) return `${m[1].padStart(2,'0')}/${m[2].padStart(2,'0')}/20${m[3]}`;
      }
      return new Date().toLocaleDateString('pt-PT', { timeZone: 'UTC' });
    };

    const formatBRL = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL'}).format(v || 0);
    const round2 = (v) => Math.round((v + Number.EPSILON) * 100) / 100;

    const ptDateToDateObj = (pt) => {
      const m = String(pt || '').match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (!m) return null;
      return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]), 12);
    };

    const monthKeyFromPtDate = (pt) => {
      const m = String(pt || '').match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (!m) return null;
      return `${m[3]}-${m[2].padStart(2,'0')}`;
    };

    const monthKeyFromDateObj = (d) => {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2,'0');
      return `${yyyy}-${mm}`;
    };

    const currentMonthKey = () => monthKeyFromDateObj(new Date());

    const monthLabel = (monthKey) => {
      if (!monthKey) return '';
      const [yyyy, mm] = monthKey.split('-').map(Number);
      const d = new Date(yyyy, mm - 1, 1);
      const nomeMes = d.toLocaleDateString('pt-BR', { month: 'long' });
      return `${nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1)} ${yyyy}`;
    };

    const shiftMonthKey = (monthKey, delta) => {
      if (!monthKey) return currentMonthKey();
      const [yyyy, mm] = monthKey.split('-').map(Number);
      const d = new Date(yyyy, mm - 1 + delta, 1);
      return monthKeyFromDateObj(d);
    };

    const ownerFromPaymentSource = (src) => {
      const s = norm(src);
      if (!s) return null;
      if (s.includes('2581') || s.includes('guilherme')) return 'Guilherme';
      if (s.includes('1009') || s.includes('thais')) return 'Thais';
      if (s.includes('7292') || s.includes('digital')) return 'Ambos';
      return null;
    };

    /* ========= MIGRATION UTILS ========= */
    async function backfillAllMonthKeys(db) {
      const { collection, query, orderBy, limit, startAfter, getDocs, writeBatch, documentId } = window.FirebaseLib;
      const expCol = collection(db, 'expenses');
      let lastDoc = null;
      let totalAtualizados = 0;

      while (true) {
        let constraints = [orderBy(documentId()), limit(500)];
        if (lastDoc) constraints.push(startAfter(lastDoc));
        const q = query(expCol, ...constraints);
        const snap = await getDocs(q);
        if (snap.empty) break;

        const batch = writeBatch(db);
        let changed = 0;
        snap.docs.forEach(dSnap => {
          const d = dSnap.data() || {};
          if (!d.monthKey && d.date) {
            const mk = monthKeyFromPtDate(d.date);
            if (mk) { batch.update(dSnap.ref, { monthKey: mk }); changed++; }
          }
        });

        if (changed > 0) { await batch.commit(); totalAtualizados += changed; }
        lastDoc = snap.docs[snap.docs.length - 1];
      }
      if(totalAtualizados > 0) console.log(`[backfillMonthKey] Atualizados: ${totalAtualizados}`);
      localStorage.setItem('mkBackfillDone', '1');
    }

    async function backfillSplitFromPaidBy(db) {
      const { collection, query, orderBy, limit, startAfter, getDocs, writeBatch, documentId } = window.FirebaseLib;
      const expCol = collection(db, "expenses");
      let last = null, total = 0;

      while (true) {
        let constraints = [orderBy(documentId()), limit(500)];
        if (last) constraints.push(startAfter(last));
        const q = query(expCol, ...constraints);
        const snap = await getDocs(q);
        if (snap.empty) break;

        const batch = writeBatch(db);
        let changed = 0;
        snap.docs.forEach(doc => {
          const d = doc.data() || {};
          const current = norm(d.split);
          const who = norm(d.paidBy || d.owner || d.user || d.person || d.responsavel);
          if ((!current || current === "dividido") && (who === "guilherme" || who === "thais")) {
            const newSplit = who === "guilherme" ? "Guilherme" : "Thais";
            batch.update(doc.ref, { split: newSplit });
            changed++;
          }
        });

        if (changed > 0) { await batch.commit(); total += changed; }
        last = snap.docs[snap.docs.length - 1];
      }
      if(total > 0) console.log(`[backfillSplit] Atualizados: ${total}`);
      localStorage.setItem('splitBackfillDone', '1');
    }

    /* ========= Components ========= */
    const Modal = ({ isOpen, onClose, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black/60 flex justify-center items-center p-4 z-50 modal-enter backdrop-blur-sm" onClick={onClose}>
          <div className={ui.modal} onClick={(e)=>e.stopPropagation()}>
            {children}
          </div>
        </div>
      );
    };

    const UserSelectionScreen = ({ onSelectUser }) => (
      <div className="min-h-screen flex flex-col justify-center items-center p-6 bg-slate-50 dark:bg-slate-900">
        <h1 className="text-4xl font-bold mb-2 text-slate-800 dark:text-white">Meu Acerto</h1>
        <p className="text-lg text-slate-600 dark:text-slate-400 mb-8">Quem está a usar?</p>
        <div className="space-y-4 w-full max-w-xs">
          {['Guilherme', 'Thais'].map(u => (
            <button key={u} onClick={() => onSelectUser(u)}
              className={`w-full py-3 rounded-xl text-white font-semibold shadow-lg hover:brightness-110 transition-all hover:scale-105
                ${u === 'Thais' ? 'bg-pink-600' : 'bg-indigo-600'}`}>
              {u}
            </button>
          ))}
        </div>
      </div>
    );

    /* ========= Dashboard ========= */
    const Dashboard = ({ user, onLogout, db }) => {
      const [expenses, setExpenses] = useState([]);
      const [installmentPlans, setInstallmentPlans] = useState([]);
      const [monthsFromDb, setMonthsFromDb] = useState([]);
      
      const [currentMonth, setCurrentMonth] = useState(() => currentMonthKey());
      
      const [filterType, setFilterType] = useState('Todos');
      const [scope, setScope] = useState('geral');

      const [isAddOpen, setIsAddOpen] = useState(false);
      const [isImportOpen, setIsImportOpen] = useState(false);
      const [isClearOpen, setIsClearOpen] = useState(false);
      const [isDelOpen, setDelOpen] = useState(false);
      
      const [delTarget, setDelTarget] = useState(null);
      const [deleting, setDeleting] = useState(false);
      const [importedExpenses, setImportedExpenses] = useState([]);
      const [isImporting, setIsImporting] = useState(false);
      const fileInputRef = useRef(null);

      const [fDesc, setFDesc] = useState('');
      const [fValor, setFValor] = useState('');
      const [fData, setFData] = useState(() => new Date().toLocaleDateString('pt-PT', { timeZone: 'UTC' }));
      const [fTipo, setFTipo] = useState('Cartão');
      const [fSplit, setFSplit] = useState('Dividido');
      const [fFonte, setFFonte] = useState(user === 'Guilherme' ? 'Cartão Guilherme (final 2581)' : 'Cartão Thais (final 1009)');
      const [fParcela, setFParcela] = useState('');
      const [salvando, setSalvando] = useState(false);
      const [editingId, setEditingId] = useState(null);

      const { collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, runTransaction, writeBatch, query, where } = window.FirebaseLib;

      const theme = user === 'Thais' 
        ? { text:'text-pink-600 dark:text-pink-400', bg:'bg-pink-600', hover:'hover:bg-pink-700' }
        : { text:'text-indigo-600 dark:text-indigo-400', bg:'bg-indigo-600', hover:'hover:bg-indigo-700' };

      const valorRef = useRef(null);
      const formatBRLInput = (digits, negative=false) => {
        const n = (Number(digits) || 0) / 100;
        const fmt = n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        return negative ? `-${fmt}` : fmt;
      };
      const handleValorChange = (e) => {
        const raw = e.target.value;
        const negative = raw.trim().startsWith('-');
        const digits = raw.replace(/\D/g, '');
        if (!digits) { setFValor(negative ? '-' : ''); return; }
        setFValor(formatBRLInput(digits, negative));
      };

      // Listeners
      useEffect(() => {
        if (!db) return;
        const plansRef = collection(db, 'installmentPlans');
        const unsub = onSnapshot(plansRef, (s) => setInstallmentPlans(s.docs.map(d => ({ id: d.id, ...d.data() }))));
        return () => unsub();
      }, [db]);

      useEffect(() => {
        if (!db) return;
        const expRef = collection(db, 'expenses');
        const unsub = onSnapshot(expRef, (s) => {
           const set = new Set();
           s.forEach(d => { const mk = d.data().monthKey; if(mk) set.add(mk); });
           setMonthsFromDb(Array.from(set).sort());
        });
        return () => unsub();
      }, [db]);

      useEffect(() => {
        if (!db || !currentMonth) return;
        const expRef = collection(db, 'expenses');
        const q = query(expRef, where('monthKey', '==', currentMonth));
        const unsub = onSnapshot(q, (s) => {
            setExpenses(s.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        return () => unsub();
      }, [db, currentMonth]);

      // Geração Parcelas
      useEffect(() => {
        if (!installmentPlans.length || !db) return;
        const generate = async () => {
            const expCol = collection(db, 'expenses');
            const batch = writeBatch(db);
            let hasWrites = false;
            for (const plan of installmentPlans) {
                if (!plan.startDate || !plan.numberOfInstallments || !plan.totalAmount) continue;
                const [dd, mm, yyyy] = String(plan.startDate).split('/').map(Number);
                const start = new Date(yyyy, mm - 1, dd, 12);
                const deletedSet = new Set(plan.deletedParcels || []);
                const per = round2(plan.totalAmount / plan.numberOfInstallments);
                const last = round2(plan.totalAmount - per * (plan.numberOfInstallments - 1));
                for (let i = 0; i < plan.numberOfInstallments; i++) {
                    const d = new Date(start.getFullYear(), start.getMonth() + i, start.getDate(), 12);
                    const parcelaKey = `${i+1}/${plan.numberOfInstallments}`;
                    if (deletedSet.has(parcelaKey)) continue;
                    const mk = monthKeyFromDateObj(d);
                    const dateStr = d.toLocaleDateString('pt-PT', { timeZone: 'UTC' });
                    const amount = (i+1) === plan.numberOfInstallments ? last : per;
                    const qDup = query(expCol, where('installmentPlanId','==', plan.id), where('parcela','==', parcelaKey), where('monthKey','==', mk));
                    const snap = await window.FirebaseLib.getDocs(qDup);
                    if (snap.empty) {
                        const newRef = doc(expCol);
                        batch.set(newRef, {
                            installmentPlanId: plan.id, description: plan.description, amount,
                            date: dateStr, parcela: parcelaKey, split: plan.split || 'Dividido',
                            type: plan.type || 'Cartão', paymentSource: plan.paymentSource || 'Cartão',
                            paidBy: 'Cartão', monthKey: mk
                        });
                        hasWrites = true;
                    }
                }
            }
            if (hasWrites) await batch.commit();
        };
        generate();
      }, [installmentPlans, db]);

      /* ==== Derivados ==== */
      const availableMonths = useMemo(() => {
        const set = new Set(monthsFromDb);
        set.add(currentMonth);
        return Array.from(set).sort();
      }, [monthsFromDb, currentMonth]);

      const expensesForScope = useMemo(() => {
        let base = expenses;
        if (scope === 'cartao') base = base.filter(e => e.type === 'Cartão');
        else if (scope === 'pixboleto') base = base.filter(e => ['Pix', 'Boleto', 'Ajuste'].includes(e.type));
        return base;
      }, [expenses, scope]);

      const filteredList = useMemo(() => {
        let base = expenses;
        if (filterType !== 'Todos') base = base.filter(e => e.type === filterType);
        return base.sort((a,b) => {
            const da = ptDateToDateObj(a.date);
            const db = ptDateToDateObj(b.date);
            return (da && db) ? da - db : 0;
        });
      }, [expenses, filterType]);

      const { partG, partT, gPaid, tPaid } = useMemo(() => {
        let pG = 0, pT = 0, paidG = 0, paidT = 0;
        for (const e of expensesForScope) {
            const val = Number(e.amount || 0);
            if (e.split === 'Dividido') { pG += val/2; pT += val/2; }
            else if (e.split === 'Guilherme') pG += val;
            else if (e.split === 'Thais') pT += val;
            if (e.type === 'Cartão') {
                const owner = ownerFromPaymentSource(e.paymentSource);
                if (owner === 'Guilherme') paidG += val;
                else if (owner === 'Thais') paidT += val;
                else if (owner === 'Ambos') { paidG += val/2; paidT += val/2; }
            } else {
                if (e.paidBy === 'Guilherme') paidG += val;
                else if (e.paidBy === 'Thais') paidT += val;
            }
        }
        return { partG: round2(pG), partT: round2(pT), gPaid: round2(paidG), tPaid: round2(paidT) };
      }, [expensesForScope]);

      const difGastos = round2(partG - partT);
      const valorDevolverSePagarTudo = user === 'Guilherme' ? round2(gPaid - partG) : round2(tPaid - partT);

      const saldoDevedorThais = useMemo(() => {
         let pG=0, paidG=0;
         for (const e of expenses) {
            const val = Number(e.amount || 0);
            if (e.split === 'Dividido') pG += val/2;
            else if (e.split === 'Guilherme') pG += val;
            if (e.type === 'Cartão') {
                const owner = ownerFromPaymentSource(e.paymentSource);
                if (owner === 'Guilherme') paidG += val;
                else if (owner === 'Ambos') paidG += val/2;
            } else {
                if (e.paidBy === 'Guilherme') paidG += val;
            }
         }
         return round2(paidG - pG);
      }, [expenses]);

      const cardTotals = useMemo(() => {
        let tot=0, g=0, t=0, d=0;
        for (const e of expenses) {
            if (e.type !== 'Cartão') continue;
            const val = Number(e.amount||0);
            tot+=val;
            const o = ownerFromPaymentSource(e.paymentSource);
            if (o === 'Guilherme') g+=val;
            else if (o === 'Thais') t+=val;
            else if (o === 'Ambos') d+=val;
        }
        return { grandTotal: round2(tot), gCard: round2(g), tCard: round2(t), dCard: round2(d) };
      }, [expenses]);

      /* ==== Ações ==== */
      const salvarLancamento = async () => {
        const val = parseMoney(fValor);
        if (!fDesc || !Number.isFinite(val)) return;
        const mk = monthKeyFromPtDate(fData) || currentMonth;
        setSalvando(true);
        const expRef = collection(db, 'expenses');
        const payload = {
            description: fDesc, amount: val, date: fData, 
            split: fTipo==='Ajuste'?'Thais':fSplit,
            type: fTipo, paymentSource: fTipo==='Cartão'?fFonte:fTipo,
            paidBy: fTipo==='Cartão'?'Cartão':(fTipo==='Ajuste'?'Thais':user),
            monthKey: mk, parcela: fParcela || null
        };
        try {
            if (editingId) await updateDoc(doc(expRef, editingId), payload);
            else await addDoc(expRef, payload);
            setIsAddOpen(false);
            setFDesc(''); setFValor(''); setFParcela('');
        } catch(e) { console.error(e); }
        setSalvando(false);
      };

      const makeDedupeKey = (e) => 
        `${norm(e.description)}|${e.amount}|${e.date}|${e.parcela||''}|${norm(e.type)}|${norm(e.paymentSource)}|${e.monthKey}`;

      const handleFileChange = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        setIsImporting(true);
        try {
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
            const [header, ...body] = rows;
            const idxDate = header.findIndex(h => norm(h).includes('data'));
            const idxDesc = header.findIndex(h => norm(h).includes('desc'));
            const idxVal  = header.findIndex(h => norm(h).includes('valor'));
            const mapped = [];
            for (const row of body) {
                if (!row[idxDate] || !row[idxDesc]) continue;
                const dateStr = excelSerialToPT(row[idxDate]);
                const amount = parseMoney(row[idxVal]);
                if (!Number.isFinite(amount)) continue;
                mapped.push({
                    description: String(row[idxDesc]).trim(), amount: round2(amount),
                    date: dateStr, type: 'Cartão', paymentSource: 'Cartão', split: 'Dividido', paidBy: 'Cartão',
                    monthKey: monthKeyFromPtDate(dateStr) || currentMonth, parcela: null
                });
            }
            setImportedExpenses(mapped);
            setIsImportOpen(true);
        } catch(err) { console.error(err); }
        setIsImporting(false);
        if (fileInputRef.current) fileInputRef.current.value = '';
      };

      const confirmImport = async () => {
        if (!importedExpenses.length) return;
        const existingKeys = new Set(expenses.map(makeDedupeKey));
        const batch = writeBatch(db);
        const expRef = collection(db, 'expenses');
        let count = 0;
        importedExpenses.forEach(imp => {
            const key = makeDedupeKey(imp);
            if (!existingKeys.has(key)) { batch.set(doc(expRef), imp); count++; }
        });
        if (count > 0) await batch.commit();
        setIsImportOpen(false);
        setImportedExpenses([]);
      };

      const doDelete = async () => {
        if (!delTarget) return;
        setDeleting(true);
        const expRef = doc(db, 'expenses', delTarget.id);
        try {
             if (delTarget.installmentPlanId && delTarget.parcela) {
                 const planRef = doc(db, 'installmentPlans', delTarget.installmentPlanId);
                 await runTransaction(db, async (t) => {
                     const planSnap = await t.get(planRef);
                     if (planSnap.exists()) {
                         const data = planSnap.data();
                         const deleted = data.deletedParcels || [];
                         t.update(planRef, { deletedParcels: [...deleted, delTarget.parcela] });
                     }
                     t.delete(expRef);
                 });
             } else { await deleteDoc(expRef); }
             setDelTarget(null);
             setDelOpen(false);
        } catch(e) { console.error(e); }
        setDeleting(false);
      };

      const clearCurrentMonth = async () => {
        try {
            const expRef = collection(db, 'expenses');
            const q = query(expRef, where('monthKey','==', currentMonth));
            const snap = await window.FirebaseLib.getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
            setIsClearOpen(false);
        } catch(e) { console.error(e); }
      };

      const clearAll = async () => {
         try {
             const q = query(collection(db, 'expenses'));
             const snap = await window.FirebaseLib.getDocs(q);
             const batch = writeBatch(db);
             snap.forEach(d => batch.delete(d.ref));
             await batch.commit();
             setIsClearOpen(false);
         } catch(e) { console.error(e); }
      };

      /* ==== UI ==== */
      return (
        <div className="min-h-screen flex flex-col pb-12 bg-slate-50 dark:bg-slate-900">
            <header className="bg-white dark:bg-slate-800 shadow-sm px-4 py-3 flex justify-between items-center sticky top-0 z-10">
                <div className="flex items-center gap-2">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold ${theme.bg}`}>{user[0]}</div>
                    <div><h1 className="font-bold text-sm sm:text-base text-slate-900 dark:text-slate-100">Meu Acerto</h1><p className="text-xs text-slate-500 dark:text-slate-400">Mês: {monthLabel(currentMonth)}</p></div>
                </div>
                <div className="flex items-center gap-2">
                   <div className="hidden sm:flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                       {['geral','cartao','pixboleto'].map(s => (
                           <button key={s} onClick={()=>setScope(s)} className={`px-3 py-1 rounded-md text-xs font-medium transition ${scope===s ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-indigo-300' : 'text-slate-500 dark:text-slate-400'}`}>{s==='geral'?'Geral':s==='cartao'?'Cartão':'Pix'}</button>
                       ))}
                   </div>
                   <button onClick={onLogout} className="p-2 bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300">
                       <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                   </button>
                </div>
            </header>

            <main className="max-w-5xl mx-auto w-full p-4 space-y-4">
                <div className="flex items-center justify-between bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm">
                    <button onClick={()=>setCurrentMonth(m => shiftMonthKey(m, -1))} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full text-slate-600 dark:text-slate-300">◀</button>
                    <div className="flex items-center gap-2">
                        <select value={currentMonth} onChange={e=>setCurrentMonth(e.target.value)} className="bg-transparent font-semibold text-center outline-none cursor-pointer text-slate-900 dark:text-slate-100">
                            {availableMonths.map(m => <option key={m} value={m} className="dark:bg-slate-800">{monthLabel(m)}</option>)}
                        </select>
                    </div>
                    <button onClick={()=>setCurrentMonth(m => shiftMonthKey(m, 1))} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full text-slate-600 dark:text-slate-300">▶</button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm">
                        <p className="text-xs text-slate-500 dark:text-slate-400 mb-1">Divisão ({scope})</p>
                        <div className="flex justify-between items-end mb-1"><span className="text-sm text-slate-700 dark:text-slate-200">Guilherme</span><span className="font-bold text-slate-900 dark:text-slate-100">{formatBRL(partG)}</span></div>
                        <div className="flex justify-between items-end"><span className="text-sm text-slate-700 dark:text-slate-200">Thais</span><span className="font-bold text-slate-900 dark:text-slate-100">{formatBRL(partT)}</span></div>
                        <div className="mt-2 pt-2 border-t border-slate-100 dark:border-slate-700 flex justify-between text-xs text-slate-500 dark:text-slate-400"><span>Diferença</span><span className="font-semibold text-slate-700 dark:text-slate-300">{formatBRL(difGastos)}</span></div>
                    </div>
                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm">
                        <p className="text-xs text-slate-500 dark:text-slate-400 mb-1">Pagamentos ({scope})</p>
                        <div className="flex justify-between items-end mb-1"><span className="text-sm text-slate-700 dark:text-slate-200">Guilherme</span><span className="font-bold text-emerald-600 dark:text-emerald-400">{formatBRL(gPaid)}</span></div>
                        <div className="flex justify-between items-end"><span className="text-sm text-slate-700 dark:text-slate-200">Thais</span><span className="font-bold text-emerald-600 dark:text-emerald-400">{formatBRL(tPaid)}</span></div>
                        <div className="mt-2 pt-2 border-t border-slate-100 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400">Se {user} quitar tudo: <span className="font-semibold text-slate-700 dark:text-slate-300">{formatBRL(valorDevolverSePagarTudo)}</span></div>
                    </div>
                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-16 h-16 bg-indigo-50 dark:bg-indigo-900/20 rounded-bl-full -mr-4 -mt-4"></div>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mb-1">Saldo Geral (Thais → Gui)</p>
                        <p className={`text-2xl font-extrabold ${saldoDevedorThais > 0 ? 'text-amber-500 dark:text-amber-400' : 'text-emerald-500 dark:text-emerald-400'}`}>{formatBRL(saldoDevedorThais)}</p>
                        <p className="text-[10px] text-slate-400 dark:text-slate-500 mt-1">Total faturas: {formatBRL(cardTotals.grandTotal)}</p>
                    </div>
                </div>

                <div className="flex gap-2 overflow-x-auto pb-2">
                    <button onClick={()=>setIsAddOpen(true)} className={`flex-shrink-0 px-4 py-2 rounded-xl text-white font-semibold shadow ${theme.bg} ${theme.hover}`}>+ Novo</button>
                    <button onClick={()=>fileInputRef.current?.click()} className="flex-shrink-0 px-4 py-2 rounded-xl bg-white dark:bg-slate-800 shadow text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700">Importar</button>
                    <input ref={fileInputRef} type="file" hidden onChange={handleFileChange} />
                    <button onClick={()=>setIsClearOpen(true)} className="flex-shrink-0 px-4 py-2 rounded-xl bg-white dark:bg-slate-800 shadow text-red-500 hover:bg-red-50 dark:hover:bg-slate-700">Limpar</button>
                </div>

                <div className="rounded-2xl overflow-hidden">
                    <div className="flex gap-2 p-1 mb-2 overflow-x-auto">
                         {['Todos','Cartão','Pix','Boleto','Ajuste'].map(f => (
                             <button key={f} onClick={()=>setFilterType(f)} className={`px-3 py-1 rounded-full text-xs transition ${filterType===f ? theme.bg + ' text-white' : 'bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400'}`}>{f}</button>
                         ))}
                    </div>
                    
                    {/* LISTA DE CARDS FLUTUANTES (SPACE-Y-2) */}
                    <div className="flex flex-col space-y-2">
                        {filteredList.length === 0 && <div className="p-8 text-center text-slate-500 dark:text-slate-400 text-sm bg-white dark:bg-slate-800 rounded-2xl">Nenhum lançamento neste mês.</div>}
                        {filteredList.map(e => (
                            <div key={e.id} onClick={()=>{setDelTarget(e); setDelOpen(true);}} 
                                 className={`relative p-4 pl-5 flex items-center justify-between bg-white dark:bg-slate-800 rounded-2xl shadow-sm hover:shadow-md cursor-pointer transition-all ${stripeBySplit(e)}`}>
                                <div className="flex-1 min-w-0 pr-2">
                                    <div className="flex items-baseline gap-2">
                                        <span className="font-semibold text-sm truncate text-slate-900 dark:text-slate-100">{e.description}</span>
                                        <span className="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400">{e.type}</span>
                                    </div>
                                    <div className="text-xs text-slate-500 dark:text-slate-400 truncate mt-0.5">{e.date} • {e.paymentSource} {e.parcela && `• ${e.parcela}`}</div>
                                </div>
                                <div className="text-right">
                                    <div className={`font-bold text-sm ${e.amount < 0 ? 'text-emerald-500 dark:text-emerald-400' : 'text-slate-900 dark:text-slate-100'}`}>{formatBRL(e.amount)}</div>
                                    <div className="text-[10px] text-slate-400 dark:text-slate-500">{e.split}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </main>

            {/* Modal Novo Lançamento */}
            <Modal isOpen={isAddOpen} onClose={()=>setIsAddOpen(false)}>
                <h3 className="text-lg font-semibold mb-4 text-slate-900 dark:text-slate-100">{editingId ? 'Editar Lançamento' : 'Novo Lançamento'}</h3>
                <label className={ui.label}>Descrição</label>
                <input className={ui.input} placeholder="Ex: Mercado, Uber..." value={fDesc} onChange={e=>setFDesc(e.target.value)} />
                <div className="grid grid-cols-2 gap-3 mt-3">
                    <div>
                        <label className={ui.label}>Valor</label>
                        <input ref={valorRef} className={ui.input} placeholder="0,00" value={fValor} onChange={handleValorChange} />
                    </div>
                    <div>
                        <label className={ui.label}>Data</label>
                        <input className={ui.input} placeholder="dd/mm/aaaa" value={fData} onChange={e=>setFData(e.target.value)} />
                    </div>
                </div>
                <div className="grid grid-cols-2 gap-3 mt-3">
                    <div>
                        <label className={ui.label}>Tipo</label>
                        <select className={ui.select} value={fTipo} onChange={e=>setFTipo(e.target.value)}>
                            <option>Cartão</option><option>Pix</option><option>Boleto</option><option disabled={user!=='Thais'}>Ajuste</option>
                        </select>
                    </div>
                    <div>
                        <label className={ui.label}>Divisão</label>
                        <select className={ui.select} value={fSplit} onChange={e=>setFSplit(e.target.value)} disabled={fTipo==='Ajuste'}>
                            <option>Dividido</option><option>Guilherme</option><option>Thais</option>
                        </select>
                    </div>
                </div>
                <div className="mt-3">
                    <label className={ui.label}>Cartão / Origem</label>
                    {fTipo==='Cartão' ? (
                        <select className={ui.select} value={fFonte} onChange={e=>setFFonte(e.target.value)}>
                            <option>Cartão Guilherme (final 2581)</option>
                            <option>Cartão Thais (final 1009)</option>
                            <option>Cartão Digital (final 7292)</option>
                        </select>
                    ) : (
                        <input className={ui.input} value={fTipo} disabled />
                    )}
                </div>
                {fTipo==='Cartão' && (
                    <div className="mt-3">
                        <label className={ui.label}>Parcela</label>
                        <input className={ui.input} placeholder="Parcela (ex: 1/10)" value={fParcela} onChange={e=>setFParcela(e.target.value)} />
                    </div>
                )}
                <div className="mt-6 flex items-center justify-end gap-3">
                    <button className={ui.btnGhost} onClick={()=>setIsAddOpen(false)}>Cancelar</button>
                    <button className={ui.btnPrimary} onClick={salvarLancamento} disabled={salvando}>{salvando ? 'Salvando...' : 'Salvar'}</button>
                </div>
            </Modal>
            
            {/* Outros Modais (Import, Delete, Clear) mantidos com estilo dark mode */}
            <Modal isOpen={isImportOpen} onClose={()=>setIsImportOpen(false)}>
                <h3 className="font-bold mb-2 text-slate-900 dark:text-slate-100">Confirmar Importação</h3>
                <p className="text-sm mb-4 text-slate-600 dark:text-slate-400">Encontrados {importedExpenses.length} itens novos.</p>
                <div className="max-h-40 overflow-y-auto bg-slate-50 dark:bg-slate-800 p-2 text-xs mb-4 space-y-1 rounded border dark:border-slate-700">
                    {importedExpenses.map((e,i)=><div key={i} className="flex justify-between text-slate-700 dark:text-slate-300"><span>{e.description}</span><span>{formatBRL(e.amount)}</span></div>)}
                </div>
                <button onClick={confirmImport} className={ui.btnPrimary + " w-full"}>Importar</button>
            </Modal>

            <Modal isOpen={isDelOpen} onClose={()=>setDelOpen(false)}>
                <div className="p-2 text-center">
                    <h3 className="font-bold text-red-500 mb-2">Excluir Lançamento?</h3>
                    <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">{delTarget?.description} ({formatBRL(delTarget?.amount)})</p>
                    <div className="flex justify-center gap-2">
                        <button onClick={()=>setDelOpen(false)} className={ui.btnGhost}>Cancelar</button>
                        <button onClick={doDelete} className="rounded-xl px-4 py-2 bg-red-500 text-white font-semibold hover:bg-red-600">Excluir</button>
                    </div>
                </div>
            </Modal>
            
            <Modal isOpen={isClearOpen} onClose={()=>setIsClearOpen(false)}>
                 <div className="p-2 space-y-3">
                    <h3 className="font-bold text-lg mb-2 text-slate-900 dark:text-slate-100">Limpar Dados</h3>
                    <p className="text-sm text-slate-600 dark:text-slate-400">Escolha o que deseja apagar:</p>
                    <button onClick={clearCurrentMonth} className="w-full py-3 rounded-xl bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-200 font-semibold hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors">Limpar Apenas {monthLabel(currentMonth)}</button>
                    <div className="border-t border-slate-100 dark:border-slate-700 my-2"></div>
                    <button onClick={clearAll} className="w-full py-3 rounded-xl bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-semibold hover:bg-red-100 dark:hover:bg-red-900/50 text-xs transition-colors">⚠️ Apagar TUDO (Reset Geral)</button>
                    <button onClick={()=>setIsClearOpen(false)} className="w-full py-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-xs mt-2">Cancelar</button>
                 </div>
            </Modal>
        </div>
      );
    };

    /* ========= Root ========= */

    const App = () => {
      const [currentUser, setCurrentUser] = useState(() => JSON.parse(localStorage.getItem('meuAcertoUser') || 'null'));
      const [db, setDb] = useState(null);
      const [ready, setReady] = useState(false);
      
      const { initializeApp, getFirestore, getAuth, signInAnonymously, onAuthStateChanged, enableIndexedDbPersistence } = window.FirebaseLib;

      useEffect(() => {
        const firebaseConfig = {
          apiKey: "AIzaSyCeecZ8a4rPnf26IItU-HaaeRpcv5xPTkk",
          authDomain: "meu-acerto-app.firebaseapp.com",
          projectId: "meu-acerto-app",
          storageBucket: "meu-acerto-app.appspot.com",
          messagingSenderId: "326844075367",
          appId: "1:326844075367:web:0315e86713b1e0071f33c2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);

        enableIndexedDbPersistence(firestore).catch(err => {
             if (err.code == 'failed-precondition') console.warn('Persistência falhou: múltiplas abas abertas.');
             else if (err.code == 'unimplemented') console.warn('Persistência não suportada.');
        });

        setDb(firestore);
        signInAnonymously(auth).catch(console.error);
        return onAuthStateChanged(auth, (u) => setReady(!!u));
      }, []);

      // TRIGGER DA MIGRAÇÃO
      useEffect(() => {
        if (!db || !ready) return;
        
        // 1. Migra MonthKey
        if (localStorage.getItem('mkBackfillDone') !== '1') {
           backfillAllMonthKeys(db).catch(err => console.error('Backfill MonthKey:', err));
        }

        // 2. Migra Split (Novo)
        if (localStorage.getItem('splitBackfillDone') !== '1') {
           backfillSplitFromPaidBy(db).catch(err => console.error('Backfill Split:', err));
        }
      }, [db, ready]);

      if (!ready) return <div className="min-h-screen flex items-center justify-center text-slate-400 animate-pulse">Carregando...</div>;
      if (!currentUser) return <UserSelectionScreen onSelectUser={(u)=>{setCurrentUser(u); localStorage.setItem('meuAcertoUser', JSON.stringify(u));}} />;
      
      return <Dashboard user={currentUser} onLogout={()=>{setCurrentUser(null); localStorage.removeItem('meuAcertoUser');}} db={db} />;
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
    
    if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
        navigator.serviceWorker.register('sw.js').catch(() => {});
    }
  </script>
</body>
</html>