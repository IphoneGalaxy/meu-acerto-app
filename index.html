<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meu Acerto</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Meu Acerto" />
  <meta name="theme-color" content="#4338ca" />
  <link rel="apple-touch-icon" href="https://placehold.co/180x180/4338ca/ffffff?text=Acerto" />

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (JSX no browser) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase compat (v10) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .modal-enter { animation: fadeIn 0.3s ease-out; }
    .modal-leave { animation: fadeOut 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    const { createRoot } = ReactDOM;

    // ================== Helpers ==================
    const norm = (s) =>
      (s ?? '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim().toLowerCase();

    // Conversor robusto de dinheiro (pt/BRL)
    const parseMoney = (input) => {
      if (typeof input === 'number') return input;
      if (input == null) return 0;

      let s = String(input)
        .replace(/\u00A0/g, '')      // NBSP
        .replace(/[\sR$]/gi, '')     // remove espaços e "R$"
        .trim();

      const hasComma = s.includes(',');
      const hasDot   = s.includes('.');

      if (hasComma && hasDot) {
        // separador decimal = o último a aparecer
        const lastComma = s.lastIndexOf(',');
        const lastDot   = s.lastIndexOf('.');
        const dec = lastComma > lastDot ? ',' : '.';
        const thou = dec === ',' ? '.' : ',';
        s = s.replace(new RegExp('\\' + thou, 'g'), '');
        s = s.replace(dec, '.');
      } else if (hasComma) {
        s = s.replace(/\./g, '').replace(',', '.');
      } else {
        s = s.replace(/,/g, '');
      }

      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    };

    // Serial Excel ou string -> dd/mm/aaaa
    const excelSerialToPT = (v) => {
      if (typeof v === 'number') {
        const ms = Math.round((v - 25569) * 86400 * 1000);
        return new Date(ms).toLocaleDateString('pt-PT');
      }
      if (typeof v === 'string') {
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) return v; // dd/mm/aaaa
        if (/^\d{4}-\d{2}-\d{2}/.test(v)) return new Date(v).toLocaleDateString('pt-PT'); // yyyy-mm-dd
        const m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})$/); // dd/mm/aa
        if (m) return `${m[1].padStart(2,'0')}/${m[2].padStart(2,'0')}/20${m[3]}`;
      }
      return new Date().toLocaleDateString('pt-PT');
    };

    const formatBRL = (value) =>
      new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'BRL' }).format(value || 0);

    // ================== UI Genéricos ==================
    const Modal = ({ isOpen, onClose, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black/60 flex justify-center items-center p-4 z-50 modal-enter" onClick={onClose}>
          <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md m-4" onClick={(e) => e.stopPropagation()}>
            {children}
          </div>
        </div>
      );
    };

    const UserSelectionScreen = ({ onSelectUser }) => {
      const users = ['Guilherme', 'Thais'];
      return (
        <div className="min-h-screen flex flex-col justify-center items-center p-4">
          <h1 className="text-4xl font-bold mb-2">Meu Acerto</h1>
          <p className="text-lg text-slate-600 dark:text-slate-400 mb-8">Quem está a usar?</p>
          <div className="space-y-4 w-full max-w-xs flex flex-col items-center">
            {users.map((user) => (
              <button
                key={user}
                onClick={() => onSelectUser(user)}
                className={`w-full text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition-transform hover:scale-105 ${user === 'Thais' ? 'bg-pink-600 hover:bg-pink-700' : 'bg-indigo-600 hover:bg-indigo-700'}`}
              >
                {user}
              </button>
            ))}
          </div>
        </div>
      );
    };

    // ================== Dashboard ==================
    const Dashboard = ({ user, onLogout, db }) => {
      const [expenses, setExpenses] = useState([]);
      const [installmentPlans, setInstallmentPlans] = useState([]);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [isImportModalOpen, setImportModalOpen] = useState(false);
      const [isClearModalOpen, setIsClearModalOpen] = useState(false);
      const [deletingExpenseId, setDeletingExpenseId] = useState(null);
      const [editingExpense, setEditingExpense] = useState(null);
      const [importedExpenses, setImportedExpenses] = useState([]);
      const [filter, setFilter] = useState('Todos');
      const fileInputRef = useRef(null);

      const otherUser = user === 'Guilherme' ? 'Thais' : 'Guilherme';
      const themes = {
        Guilherme: { text: 'text-indigo-600', darkText: 'dark:text-indigo-400', bg: 'bg-indigo-600', hoverBg: 'hover:bg-indigo-700', ring: 'focus:ring-indigo-500', border: 'focus:border-indigo-500', borderClass: 'border-indigo-500' },
        Thais: { text: 'text-pink-600', darkText: 'dark:text-pink-400', bg: 'bg-pink-600', hoverBg: 'hover:bg-pink-700', ring: 'focus:ring-pink-500', border: 'focus:border-pink-500', borderClass: 'border-pink-500' }
      };
      const theme = themes[user] || themes.Guilherme;

      const expensesColRef = useMemo(() => db.collection('expenses'), [db]);
      const plansColRef = useMemo(() => db.collection('installmentPlans'), [db]);

      useEffect(() => {
        if (!db) return;
        const unsub1 = expensesColRef.onSnapshot((snap) =>
          setExpenses(snap.docs.map((d) => ({ ...d.data(), id: d.id })))
        );
        const unsub2 = plansColRef.onSnapshot((snap) =>
          setInstallmentPlans(snap.docs.map((d) => ({ ...d.data(), id: d.id })))
        );
        return () => { unsub1(); unsub2(); };
      }, [db, expensesColRef, plansColRef]);

      // Geração automática de parcelas passadas faltantes
      useEffect(() => {
        if (!db || installmentPlans.length === 0) return;
        const generateMissingInstallments = async () => {
          const today = new Date();
          const batch = db.batch();
          let hasWrites = false;

          for (const plan of installmentPlans) {
            const [day, month, year] = plan.startDate.split('/');
            const startDate = new Date(year, month - 1, day);
            for (let i = 0; i < plan.numberOfInstallments; i++) {
              const instDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, startDate.getDate());
              if (instDate <= today) {
                const num = i + 1;
                const exists = expenses.some(
                  (e) => e.installmentPlanId === plan.id && e.parcela === `${num}/${plan.numberOfInstallments}`
                );
                if (!exists) {
                  const newExpense = {
                    installmentPlanId: plan.id,
                    description: plan.description,
                    amount: plan.totalAmount / plan.numberOfInstallments,
                    date: instDate.toLocaleDateString('pt-PT'),
                    parcela: `${num}/${plan.numberOfInstallments}`,
                    split: plan.split,
                    type: plan.type,
                    paymentSource: plan.paymentSource,
                    paidBy: plan.paidBy
                  };
                  batch.set(expensesColRef.doc(), newExpense);
                  hasWrites = true;
                }
              }
            }
          }
          if (hasWrites) await batch.commit();
        };
        generateMissingInstallments();
      }, [installmentPlans, expenses, db, expensesColRef]);

      const openAddModal = () => { setEditingExpense(null); setIsModalOpen(true); };
      const openEditModal = (expense) => { setEditingExpense(expense); setIsModalOpen(true); };

      const addSingleExpense = async (expense) => { await expensesColRef.add(expense); };
      const addInstallmentPlan = async (plan) => {
        const planDocRef = await plansColRef.add(plan);
        const first = {
          installmentPlanId: planDocRef.id,
          description: plan.description,
          amount: plan.totalAmount / plan.numberOfInstallments,
          date: plan.startDate,
          parcela: `1/${plan.numberOfInstallments}`,
          split: plan.split,
          type: plan.type,
          paymentSource: plan.paymentSource,
          paidBy: plan.paidBy
        };
        await expensesColRef.add(first);
      };
      const updateExpense = async ({ id, ...data }) => { await expensesColRef.doc(id).update(data); };
      const confirmAndDeleteExpense = async () => {
        if (!deletingExpenseId) return;
        await expensesColRef.doc(deletingExpenseId).delete();
        setDeletingExpenseId(null);
      };
      const confirmAndClearAll = async () => {
        const expSnap = await expensesColRef.get();
        const planSnap = await plansColRef.get();
        const batch = db.batch();
        expSnap.forEach((d) => batch.delete(d.ref));
        planSnap.forEach((d) => batch.delete(d.ref));
        await batch.commit();
        setIsClearModalOpen(false);
      };

      // ======= IMPORTAÇÃO (XLS/XLSX/CSV + senha + cabeçalho detectado) =======
      const handleFileUpload = (event) => {
        try {
          const file = event.target.files?.[0];
          if (!file) return;

          const isXLSX = /\.xlsx$/i.test(file.name);
          const isXLS  = /\.xls$/i.test(file.name);
          const isCSV  = /\.csv$/i.test(file.name);

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              let rows = [];

              if (isXLSX || isXLS) {
                const wb = XLSX.read(new Uint8Array(e.target.result), {
                  type: 'array',
                  password: '130843', // funciona mesmo sem senha
                });
                const ws = wb.Sheets[wb.SheetNames[0]];
                rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: '' });
              } else if (isCSV) {
                const txt = e.target.result;
                // Delimitador ; ou ,
                const scoreSemi  = (txt.match(/;/g) || []).length;
                const scoreComma = (txt.match(/,/g) || []).length;
                const delim = scoreSemi > scoreComma ? ';' : ',';
                rows = txt.split(/\r?\n/).map(line =>
                  line.split(delim).map(c => c.replace(/^"(.*)"$/, '$1').replace(/""/g, '"'))
                );
              } else {
                alert('Formato não suportado. Use .xls, .xlsx ou .csv');
                return;
              }

              // Detecta cabeçalho pela coluna "Data de compra"
              const headerRowIndex = rows.findIndex((r) => r.some((c) => norm(c) === 'data de compra'));
              if (headerRowIndex === -1) {
                alert('Cabeçalho não encontrado (procurei "Data de compra").');
                return;
              }
              const header = rows[headerRowIndex];

              // Índices por nome (robusto)
              const idx = {
                data: header.findIndex((c) => norm(c) === 'data de compra'),
                finalCartao: header.findIndex((c) => /final.*cartao/.test(norm(c)) || norm(c) === 'final do cartao'),
                descricao: header.findIndex((c) => norm(c) === 'descricao'),
                parcela: header.findIndex((c) => norm(c) === 'parcela'),
                valorBRL: header.findIndex((c) => /valor.*em.*r\$/.test(norm(c)))
              };

              if (idx.data < 0 || idx.descricao < 0 || idx.valorBRL < 0) {
                alert('Colunas obrigatórias não encontradas (Data de compra, Descrição, Valor (em R$)).');
                return;
              }

              const dataRows = rows.slice(headerRowIndex + 1);

              const allNewExpenses = dataRows
                .map((row) => {
                  const rawDesc  = row[idx.descricao];
                  const rawValor = row[idx.valorBRL];
                  if (!rawDesc && !rawValor) return null; // linha vazia

                  const descStr = String(rawDesc || '');
                  const descLow = norm(descStr);
                  if (descLow.includes('inclusao de pagamento') || descLow.includes('inclusão de pagamento')) {
                    return null;
                  }

                  // Final do cartão
                  const finalCartaoStr = idx.finalCartao >= 0 ? String(row[idx.finalCartao] || '').trim() : '';
                  let owner, source;
                  if (finalCartaoStr.endsWith('2581')) { owner = 'Guilherme'; source = 'Cartão Guilherme (final 2581)'; }
                  else if (finalCartaoStr.endsWith('1009')) { owner = 'Thais'; source = 'Cartão Thais (final 1009)'; }
                  else { owner = 'Digital'; source = 'Cartão Digital (final 7292)'; }

                  // Valor
                  const amount = parseMoney(rawValor);
                  if (!amount) return null;

                  let description = descStr || 'Sem descrição';
                  if (amount < 0) description = `Estorno: ${description}`;

                  const parcelaInfo =
                    idx.parcela >= 0 && row[idx.parcela] && row[idx.parcela] !== 'Única'
                      ? String(row[idx.parcela])
                      : null;

                  const dataCompra = excelSerialToPT(row[idx.data]) || new Date().toLocaleDateString('pt-PT');

                  return {
                    description,
                    amount,
                    date: dataCompra,
                    split: 'Dividido',
                    paidBy: owner,
                    paymentSource: source,
                    type: 'Cartão',
                    parcela: parcelaInfo
                  };
                })
                .filter(Boolean);

              setImportedExpenses(allNewExpenses);
              setImportModalOpen(true);
            } catch (readError) {
              console.error('Erro ao processar o ficheiro:', readError);
              alert('Não consegui ler a planilha. Confirme a senha e o layout.');
            }
          };

          if (isXLSX || isXLS) reader.readAsArrayBuffer(file);
          else if (isCSV) reader.readAsText(file, 'ISO-8859-1');

          event.target.value = null;
        } catch (uploadError) {
          console.error('Erro no upload do ficheiro:', uploadError);
          alert('Falha no upload do ficheiro.');
        }
      };

      const confirmImport = async () => {
        const uniqueImportedExpenses = importedExpenses.filter((imp) =>
          !expenses.some(
            (ex) =>
              ex.description === imp.description &&
              Math.abs(ex.amount - imp.amount) < 0.01 &&
              ex.date === imp.date &&
              ex.parcela === imp.parcela
          )
        );
        const batch = db.batch();
        uniqueImportedExpenses.forEach((e) => batch.set(expensesColRef.doc(), e));
        await batch.commit();
        setImportedExpenses([]);
        setImportModalOpen(false);
      };

      const filteredAndSortedExpenses = useMemo(() => {
        const userVisible = user === 'Guilherme'
          ? expenses.filter((e) => e.paymentSource?.includes('2581') || e.paymentSource?.includes('7292'))
          : expenses.filter((e) => e.paymentSource?.includes('1009'));
        let filtered = userVisible;
        switch (filter) {
          case 'Cartão': filtered = userVisible.filter((e) => e.type === 'Cartão' && !e.parcela); break;
          case 'Parcelados': filtered = userVisible.filter((e) => !!e.parcela); break;
          case 'Pix': filtered = userVisible.filter((e) => e.type === 'Pix'); break;
          case 'Boleto': filtered = userVisible.filter((e) => e.type === 'Boleto'); break;
          default: filtered = userVisible;
        }
        return filtered.sort((a, b) => {
          const aDate = new Date(a.date.split('/').reverse().join('-'));
          const bDate = new Date(b.date.split('/').reverse().join('-'));
          if (filter === 'Todos') {
            const ap = !!a.parcela, bp = !!b.parcela;
            if (ap !== bp) return ap ? 1 : -1;
          }
          return bDate - aDate;
        });
      }, [expenses, filter, user]);

      const totals = useMemo(() => {
        let userTotal = 0, otherUserTotal = 0;
        expenses.forEach((e) => {
          if (e.split === 'Dividido') { userTotal += e.amount / 2; otherUserTotal += e.amount / 2; }
          else if (e.split === user) { userTotal += e.amount; }
          else if (e.split === otherUser) { otherUserTotal += e.amount; }
        });
        const userPaid = expenses.filter((e) => e.paidBy === user).reduce((s, e) => s + e.amount, 0);
        const otherUserPaid = expenses.filter((e) => e.paidBy === otherUser).reduce((s, e) => s + e.amount, 0);
        const balance = otherUserTotal - otherUserPaid;

        const sumBy = (needle) => expenses.filter((e) => e.paymentSource?.includes(needle)).reduce((s, e) => s + e.amount, 0);
        const guilhermeCardTotal = sumBy('2581');
        const thaisCardTotal     = sumBy('1009');
        const digitalCardTotal   = sumBy('7292');
        const grandTotal = guilhermeCardTotal + thaisCardTotal + digitalCardTotal;

        const limiteLiberadoProximoMes = expenses.filter((e) => {
          const isUserCard =
            user === 'Guilherme'
              ? (e.paymentSource?.includes('2581') || e.paymentSource?.includes('7292'))
              : e.paymentSource?.includes('1009');
          if (!isUserCard || !e.parcela || typeof e.parcela !== 'string') return false;
          const [c, t] = e.parcela.split('/').map(Number);
          return c === t;
        }).reduce((s, e) => s + e.amount, 0);

        return { userTotal, otherUserTotal, userPaid, otherUserPaid, balance, guilhermeCardTotal, thaisCardTotal, digitalCardTotal, grandTotal, limiteLiberadoProximoMes };
      }, [expenses, user, otherUser]);

      const FilterButton = ({ label }) => {
        const isActive = filter === label;
        return (
          <button
            onClick={() => setFilter(label)}
            className={`px-2 sm:px-3 py-1 text-xs sm:text-sm font-semibold rounded-full transition ${isActive ? `${theme.bg} text-white shadow` : 'bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600'}`}
          >
            {label}
          </button>
        );
      };

      return (
        <div className="max-w-4xl mx-auto p-2 sm:p-4 pb-24">
          <header className="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-6 gap-4">
            <div>
              <h1 className="text-2xl font-bold">Olá, {user}</h1>
              <p className="text-slate-500 dark:text-slate-400">Resumo das suas despesas.</p>
            </div>
            <div className="flex items-start justify-between w-full sm:w-auto sm:space-x-6">
              <div className="text-left sm:text-right text-sm">
                <div>
                  <h3 className="font-semibold text-slate-600 dark:text-slate-400 mb-1">Total Faturas</h3>
                  <div className="space-y-1 text-slate-500 dark:text-slate-400">
                    <p>Guilherme: <span className="font-bold text-slate-700 dark:text-slate-300">{formatBRL(totals.guilhermeCardTotal)}</span></p>
                    <p>Thais: <span className="font-bold text-slate-700 dark:text-slate-300">{formatBRL(totals.thaisCardTotal)}</span></p>
                    <p>Digital: <span className="font-bold text-slate-700 dark:text-slate-300">{formatBRL(totals.digitalCardTotal)}</span></p>
                    <hr className="my-2 border-slate-200 dark:border-slate-700" />
                    <p className="font-bold">Total Geral: <span className={`${theme.text} ${theme.darkText}`}>{formatBRL(totals.grandTotal)}</span></p>
                  </div>
                </div>
                {totals.limiteLiberadoProximoMes > 0 && (
                  <div className="mt-4">
                    <h3 className="font-semibold text-slate-600 dark:text-slate-400 mb-1">Próximo Mês</h3>
                    <p className="text-slate-500 dark:text-slate-400">Limite liberado:
                      <span className="font-bold text-emerald-500 dark:text-emerald-400 ml-1">{formatBRL(totals.limiteLiberadoProximoMes)}</span>
                    </p>
                  </div>
                )}
              </div>
              <button
                onClick={onLogout}
                className={`text-slate-500 hover:${theme.text} dark:hover:${theme.darkText} transition`}
                title="Sair"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
              </button>
            </div>
          </header>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md">
              <h3 className="font-semibold mb-2 text-slate-600 dark:text-slate-400">Resultado Final</h3>
              {totals.balance >= 0 ? (
                <div>
                  <p className="text-sm">{otherUser} deve pagar-lhe</p>
                  <p className="text-2xl sm:text-3xl font-bold text-emerald-500">{formatBRL(totals.balance)}</p>
                </div>
              ) : (
                <div>
                  <p className="text-sm">Deve pagar a {otherUser}</p>
                  <p className="text-2xl sm:text-3xl font-bold text-red-500">{formatBRL(Math.abs(totals.balance))}</p>
                </div>
              )}
            </div>

            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md">
              <h3 className="font-semibold mb-2 text-slate-600 dark:text-slate-400">Detalhes</h3>
              <div className="text-sm space-y-2">
                <p>A sua parte: <span className="font-semibold">{formatBRL(totals.userTotal)}</span></p>
                <p>Parte de {otherUser}: <span className="font-semibold">{formatBRL(totals.otherUserTotal)}</span></p>
                <p>Total pago por si: <span className="font-semibold">{formatBRL(totals.userPaid)}</span></p>
                <p>Total pago por {otherUser}: <span className="font-semibold">{formatBRL(totals.otherUserPaid)}</span></p>
              </div>
            </div>
          </div>

          <div className="flex space-x-2 mb-6">
            <button
              onClick={openAddModal}
              className={`flex-1 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition flex items-center justify-center ${theme.bg} ${theme.hoverBg}`}
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Adicionar
            </button>

            <button
              onClick={() => fileInputRef.current?.click()}
              className="cursor-pointer flex-1 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-semibold py-3 px-4 rounded-xl shadow-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition flex items-center justify-center"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Importar
            </button>
            <input ref={fileInputRef} type="file" className="hidden" accept=".csv,.xlsx,.xls" onChange={handleFileUpload} multiple={false} />

            <button
              onClick={() => setIsClearModalOpen(true)}
              className="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition flex items-center justify-center"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"/></svg>
              Limpar
            </button>
          </div>

          <div className="bg-white dark:bg-slate-800 p-2 sm:p-4 rounded-2xl shadow-md">
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 px-2">
              <h2 className="text-xl font-bold mb-3 sm:mb-0">Lançamentos</h2>
              <div className="flex flex-wrap gap-1 sm:gap-2 justify-start">
                <FilterButton label="Todos" />
                <FilterButton label="Cartão" />
                <FilterButton label="Parcelados" />
                <FilterButton label="Pix" />
                <FilterButton label="Boleto" />
              </div>
            </div>

            <div className="space-y-2">
              {filteredAndSortedExpenses.length > 0 ? (
                filteredAndSortedExpenses.map((expense) => {
                  const borderClass =
                    expense.split === 'Guilherme' ? themes.Guilherme.borderClass
                    : expense.split === 'Thais' ? themes.Thais.borderClass
                    : 'border-transparent';

                  let isLastInstallment = false;
                  if (expense.parcela) {
                    const [c, t] = expense.parcela.split('/').map(Number);
                    if (c === t) isLastInstallment = true;
                  }

                  return (
                    <div key={expense.id} className={`flex flex-wrap items-center justify-between p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 border-l-4 transition-all ${borderClass} gap-2`}>
                      <div className="flex-grow">
                        <p className="font-semibold flex items-center text-sm sm:text-base">
                          {expense.description}
                          {expense.parcela && (
                            <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ml-2 ${isLastInstallment ? 'bg-emerald-100 dark:bg-emerald-800/50 text-emerald-700 dark:text-emerald-300' : 'bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300'}`}>
                              {expense.parcela}
                            </span>
                          )}
                        </p>
                        <p className="text-xs sm:text-sm text-slate-500 dark:text-slate-400">
                          {expense.date} - {expense.paymentSource || expense.paidBy} - {expense.split} - {expense.type}
                        </p>
                      </div>
                      <div className="text-right flex-shrink-0 flex items-center gap-2">
                        <p className={`font-semibold text-base sm:text-lg ${expense.amount < 0 ? 'text-emerald-500' : ''}`}>{formatBRL(expense.amount)}</p>
                        <div className="flex items-center space-x-1">
                          <button onClick={() => openEditModal(expense)} className="text-slate-400 hover:text-blue-500 p-1" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                          </button>
                          <button onClick={() => setDeletingExpenseId(expense.id)} className="text-slate-400 hover:text-red-500 p-1" title="Excluir">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })
              ) : (
                <p className="text-center text-slate-500 dark:text-slate-400 py-8">Nenhum lançamento para este filtro.</p>
              )}
            </div>
          </div>

          {/* Modais */}
          <ExpenseForm
            isOpen={isModalOpen}
            onClose={() => setIsModalOpen(false)}
            expense={editingExpense}
            currentUser={user}
            theme={theme}
            addSingleExpense={addSingleExpense}
            addInstallmentPlan={addInstallmentPlan}
            updateExpense={updateExpense}
          />

          <Modal isOpen={isImportModalOpen} onClose={() => setImportModalOpen(false)}>
            <div className="p-6">
              <h2 className="text-xl font-bold mb-4">Confirmar Importação</h2>
              <p className="mb-6">
                Está prestes a adicionar {importedExpenses.filter(i =>
                  !expenses.some(e => e.description === i.description && Math.abs(e.amount - i.amount) < 0.01 && e.date === i.date && e.parcela === i.parcela)
                ).length} novos lançamentos. Deseja continuar?
              </p>
              <div className="flex justify-end space-x-3">
                <button onClick={() => setImportModalOpen(false)} className="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">Cancelar</button>
                <button onClick={confirmImport} className={`px-4 py-2 rounded-lg text-white font-semibold ${theme.bg} ${theme.hoverBg}`} disabled={importedExpenses.length === 0}>Confirmar</button>
              </div>
            </div>
          </Modal>

          <Modal isOpen={isClearModalOpen} onClose={() => setIsClearModalOpen(false)}>
            <div className="p-6">
              <div className="flex items-center justify-center mb-4">
                <div className="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/50 flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-600 dark:text-red-400"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </div>
              </div>
              <h2 className="text-xl font-bold mb-2 text-center">Apagar Todos os Dados?</h2>
              <p className="text-slate-500 dark:text-slate-400 text-center mb-6">Esta ação é permanente. Todos os lançamentos e planos de parcelamento serão excluídos.</p>
              <div className="grid grid-cols-2 gap-3">
                <button onClick={() => setIsClearModalOpen(false)} className="w-full px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold transition">Cancelar</button>
                <button onClick={confirmAndClearAll} className="w-full px-4 py-2 rounded-lg text-white font-semibold bg-red-600 hover:bg-red-700 transition">Confirmar Exclusão</button>
              </div>
            </div>
          </Modal>

          <Modal isOpen={!!deletingExpenseId} onClose={() => setDeletingExpenseId(null)}>
            <div className="p-6">
              <h2 className="text-xl font-bold mb-2 text-center">Excluir Lançamento?</h2>
              <p className="text-slate-500 dark:text-slate-400 text-center mb-6">Tem a certeza que deseja excluir este lançamento? Esta ação não pode ser desfeita.</p>
              <div className="grid grid-cols-2 gap-3">
                <button onClick={() => setDeletingExpenseId(null)} className="w-full px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold transition">Cancelar</button>
                <button onClick={confirmAndDeleteExpense} className="w-full px-4 py-2 rounded-lg text-white font-semibold bg-red-600 hover:bg-red-700 transition">Sim, Excluir</button>
              </div>
            </div>
          </Modal>
        </div>
      );
    };

    // ================== Formulário ==================
    const ExpenseForm = ({ isOpen, onClose, expense, currentUser, theme, addSingleExpense, addInstallmentPlan, updateExpense }) => {
      const [description, setDescription] = useState('');
      const [amount, setAmount] = useState('');
      const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
      const [paymentSource, setPaymentSource] = useState('');
      const [split, setSplit] = useState('Dividido');
      const [type, setType] = useState('Cartão');
      const [totalInstallments, setTotalInstallments] = useState('1');

      useEffect(() => {
        const defaultSource = currentUser === 'Guilherme' ? 'Cartão Guilherme (final 2581)' : 'Cartão Thais (final 1009)';
        if (expense) {
          setDescription(expense.description);
          setAmount(String(expense.amount).replace('.', ','));
          setDate(expense.date ? new Date(expense.date.split('/').reverse().join('-')).toISOString().split('T')[0] : '');
          setPaymentSource(expense.paymentSource || defaultSource);
          setSplit(expense.split);
          setType(expense.type || 'Cartão');
          setTotalInstallments(expense.parcela ? expense.parcela.split('/')[1] : '1');
        } else {
          setDescription('');
          setAmount('');
          setDate(new Date().toISOString().split('T')[0]);
          setPaymentSource(defaultSource);
          setSplit('Dividido');
          setType('Cartão');
          setTotalInstallments('1');
        }
      }, [expense, isOpen, currentUser]);

      const handleSubmit = (e) => {
        e.preventDefault();
        const paidBy = paymentSource.includes('Guilherme') ? 'Guilherme' : (paymentSource.includes('Thais') ? 'Thais' : 'Digital');
        if (expense) {
          updateExpense({
            ...expense,
            description,
            amount: parseMoney(amount),
            date: new Date(date).toLocaleDateString('pt-PT', { timeZone: 'UTC' }),
            split,
            type,
            paymentSource,
            paidBy
          });
        } else {
          const n = parseInt(totalInstallments, 10) || 1;
          if (n > 1) {
            addInstallmentPlan({
              description,
              totalAmount: parseMoney(amount),
              numberOfInstallments: n,
              startDate: new Date(date).toLocaleDateString('pt-PT', { timeZone: 'UTC' }),
              split,
              type,
              paymentSource,
              paidBy
            });
          } else {
            addSingleExpense({
              description,
              amount: parseMoney(amount),
              date: new Date(date).toLocaleDateString('pt-PT', { timeZone: 'UTC' }),
              split,
              type,
              paymentSource,
              paidBy,
              parcela: null
            });
          }
        }
        onClose();
      };

      const inputClasses = `mt-1 block w-full bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md shadow-sm ${theme.ring} ${theme.border}`;

      return (
        <Modal isOpen={isOpen} onClose={onClose}>
          <form onSubmit={handleSubmit} className="p-6 space-y-4">
            <h2 className="text-xl font-bold mb-4">{expense ? 'Editar Lançamento' : 'Novo Lançamento'}</h2>
            <div>
              <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Descrição</label>
              <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} required className={inputClasses} />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Valor {expense ? '(da parcela)' : '(Total)'} (R$)</label>
                <input type="text" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="123,45" required className={inputClasses} />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">N.º de Prestações</label>
                <input type="number" value={totalInstallments} onChange={(e) => setTotalInstallments(e.target.value)} min="1" disabled={!!expense} required className={`${inputClasses} disabled:opacity-50`} />
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Data {expense ? '(do lançamento)' : '(da 1.ª prestação)'}</label>
              <input type="date" value={date} onChange={(e) => setDate(e.target.value)} required className={inputClasses} />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Pago com</label>
              <select value={paymentSource} onChange={(e) => setPaymentSource(e.target.value)} className={inputClasses}>
                <option>Cartão Guilherme (final 2581)</option>
                <option>Cartão Thais (final 1009)</option>
                <option>Cartão Digital (final 7292)</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Divisão da despesa</label>
              <select value={split} onChange={(e) => setSplit(e.target.value)} className={inputClasses}>
                <option>Dividido</option>
                <option value={currentUser}>Apenas {currentUser}</option>
                <option value="Thais">Apenas Thais</option>
                <option value="Guilherme">Apenas Guilherme</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Tipo</label>
              <select value={type} onChange={(e) => setType(e.target.value)} className={inputClasses}>
                <option>Cartão</option>
                <option>Pix</option>
                <option>Boleto</option>
              </select>
            </div>
            <div className="flex justify-end space-x-3 pt-4">
              <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">Cancelar</button>
              <button type="submit" className={`px-4 py-2 rounded-lg text-white font-semibold ${theme.bg} ${theme.hoverBg}`}>Salvar</button>
            </div>
          </form>
        </Modal>
      );
    };

    // ================== App (Firebase + Shell) ==================
    const App = () => {
      const [currentUser, setCurrentUser] = useState(() => JSON.parse(localStorage.getItem('meuAcertoUser') || 'null'));
      const [db, setDb] = useState(null);
      const [auth, setAuth] = useState(null);
      const [error, setError] = useState(null);

      useEffect(() => {
        const firebaseConfig = {
          apiKey: "AIzaSyCeecZ8a4rPnf26IItU-HaaeRpcv5xPTkk",
          authDomain: "meu-acerto-app.firebaseapp.com",
          projectId: "meu-acerto-app",
          storageBucket: "meu-acerto-app.appspot.com",
          messagingSenderId: "326844075367",
          appId: "1:326844075367:web:0315e86713b1e0071f33c2"
        };

        try {
          if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
          const firestoreDb = firebase.firestore();
          const firebaseAuth = firebase.auth();
          setDb(firestoreDb);
          setAuth(firebaseAuth);

          (async () => {
            try {
              await firebaseAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
              await firebaseAuth.signInAnonymously();
            } catch (err) {
              console.error("Auth error:", err);
              setError(`Erro de autenticação: ${err.message}. Verifique se o método de login anónimo está ativo no Firebase.`);
            }
          })();
        } catch (err) {
          console.error("Failed to initialize Firebase:", err);
          setError("Falha ao inicializar o Firebase. Verifique as credenciais.");
        }
      }, []);

      const handleSelectUser = (user) => {
        setCurrentUser(user);
        localStorage.setItem('meuAcertoUser', JSON.stringify(user));
      };
      const handleLogout = () => {
        setCurrentUser(null);
        localStorage.removeItem('meuAcertoUser');
      };

      if (error) return <div className="min-h-screen flex items-center justify-center text-red-500 font-semibold p-4 text-center">{error}</div>;
      if (!db || !auth) return <div className="min-h-screen flex items-center justify-center text-slate-500">A ligar ao servidor...</div>;
      if (!currentUser) return <UserSelectionScreen onSelectUser={handleSelectUser} />;

      return <Dashboard user={currentUser} onLogout={handleLogout} db={db} />;
    };

    // Mount + Service Worker
    window.onload = () => {
      createRoot(document.getElementById('root')).render(<App />);
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(
          (reg) => console.log('SW registado:', reg),
          (err) => console.log('Falha ao registar o SW:', err)
        );
      }
    };
  </script>
</body>
</html>
