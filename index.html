<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meu Acerto</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (JSX no browser) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase compat (v10) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <!-- PWA/ícone -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Meu Acerto" />
  <meta name="theme-color" content="#1e29b3" />
  <link rel="apple-touch-icon" href="https://placehold.co/180x180/1e29b3/ffffff?text=Acerto" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    body { font-family: 'Inter', sans-serif; }
    .modal-enter { animation: fadeIn 0.3s ease-out; }
    .modal-leave { animation: fadeOut 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { createRoot } = ReactDOM;

    // Helpers
    const parseBRFloat = (str) => {
      if (typeof str !== 'string') return typeof str === 'number' ? str : 0;
      const sanitized = str.replace(/\./g, '').replace(',', '.');
      return parseFloat(sanitized) || 0;
    };
    const formatBRL = (value) =>
      new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);

    // UI
    const Modal = ({ isOpen, onClose, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50 modal-enter" onClick={onClose}>
          <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md m-4" onClick={(e) => e.stopPropagation()}>
            {children}
          </div>
        </div>
      );
    };

    const UserSelectionScreen = ({ onSelectUser }) => {
      const users = ['Guilherme', 'Thais'];
      return (
        <div className="min-h-screen flex flex-col justify-center items-center bg-slate-100 dark:bg-slate-900 p-4">
          <h1 className="text-4xl font-bold text-slate-800 dark:text-white mb-2">Meu Acerto</h1>
          <p className="text-lg text-slate-600 dark:text-slate-400 mb-8">Quem está usando?</p>
          <div className="space-y-4">
            {users.map(user => (
              <button
                key={user}
                onClick={() => onSelectUser(user)}
                className={`w-64 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 ${
                  user === 'Thais' ? 'bg-pink-600 hover:bg-pink-700' : 'bg-indigo-600 hover:bg-indigo-700'
                }`}
              >
                {user}
              </button>
            ))}
          </div>
        </div>
      );
    };

    const Dashboard = ({ user, onLogout, db }) => {
      const [expenses, setExpenses] = useState([]);
      const [installmentPlans, setInstallmentPlans] = useState([]);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [isImportModalOpen, setImportModalOpen] = useState(false);
      const [editingExpense, setEditingExpense] = useState(null);
      const [importedExpenses, setImportedExpenses] = useState([]);
      const [filter, setFilter] = useState('Todos');

      const otherUser = user === 'Guilherme' ? 'Thais' : 'Guilherme';

      const themes = {
        Guilherme: { text: 'text-indigo-600', darkText: 'dark:text-indigo-400', bg: 'bg-indigo-600', hoverBg: 'hover:bg-indigo-700', ring: 'focus:ring-indigo-500', border: 'focus:border-indigo-500', borderClass: 'border-indigo-500' },
        Thais: { text: 'text-pink-600', darkText: 'dark:text-pink-400', bg: 'bg-pink-600', hoverBg: 'hover:bg-pink-700', ring: 'focus:ring-pink-500', border: 'focus:border-pink-500', borderClass: 'border-pink-500' }
      };
      const theme = themes[user] || themes.Guilherme;

      const expensesColRef = useMemo(() => db.collection('expenses'), [db]);
      const plansColRef = useMemo(() => db.collection('installmentPlans'), [db]);

      useEffect(() => {
        if (!db) return;
        const unsubscribeExpenses = expensesColRef.onSnapshot(snap =>
          setExpenses(snap.docs.map(doc => ({ ...doc.data(), id: doc.id })))
        );
        const unsubscribePlans = plansColRef.onSnapshot(snap =>
          setInstallmentPlans(snap.docs.map(doc => ({ ...doc.data(), id: doc.id })))
        );
        return () => { unsubscribeExpenses(); unsubscribePlans(); };
      }, [db, expensesColRef, plansColRef]);

      useEffect(() => {
        if (!db || installmentPlans.length === 0) return;
        const generateMissingInstallments = async () => {
          const today = new Date();
          const batch = db.batch();
          let hasWrites = false;

          for (const plan of installmentPlans) {
            const [day, month, year] = plan.startDate.split('/');
            const startDate = new Date(year, month - 1, day);

            for (let i = 0; i < plan.numberOfInstallments; i++) {
              const installmentDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, startDate.getDate());
              if (installmentDate <= today) {
                const installmentPlanId = plan.id;
                const installmentNumber = i + 1;
                const alreadyExists = expenses.some(exp =>
                  exp.installmentPlanId === installmentPlanId &&
                  exp.parcela === `${installmentNumber}/${plan.numberOfInstallments}`
                );
                if (!alreadyExists) {
                  const data = {
                    installmentPlanId,
                    description: plan.description,
                    amount: plan.totalAmount / plan.numberOfInstallments,
                    date: installmentDate.toLocaleDateString('pt-BR'),
                    parcela: `${installmentNumber}/${plan.numberOfInstallments}`,
                    split: plan.split,
                    type: plan.type,
                    paymentSource: plan.paymentSource,
                    paidBy: plan.paidBy
                  };
                  const newDocRef = expensesColRef.doc();
                  batch.set(newDocRef, data);
                  hasWrites = true;
                }
              }
            }
          }
          if (hasWrites) {
            try { await batch.commit(); } catch (e) { console.error("Error generating installments:", e); }
          }
        };
        generateMissingInstallments();
      }, [installmentPlans, expenses, db, expensesColRef]);

      const openAddModal = () => { setEditingExpense(null); setIsModalOpen(true); };
      const openEditModal = (expense) => { setEditingExpense(expense); setIsModalOpen(true); };

      const addSingleExpense = async (expense) => { try { await expensesColRef.add(expense); } catch (e) { console.error(e); } };
      const addInstallmentPlan = async (plan) => {
        try {
          const planDocRef = await plansColRef.add(plan);
          const first = {
            installmentPlanId: planDocRef.id,
            description: plan.description,
            amount: plan.totalAmount / plan.numberOfInstallments,
            date: plan.startDate,
            parcela: `1/${plan.numberOfInstallments}`,
            split: plan.split, type: plan.type, paymentSource: plan.paymentSource, paidBy: plan.paidBy
          };
          await expensesColRef.add(first);
        } catch (e) { console.error(e); }
      };
      const updateExpense = async ({ id, ...rest }) => { try { await expensesColRef.doc(id).update(rest); } catch (e) { console.error(e); } };
      const deleteExpense = async (id) => { if (confirm('Excluir lançamento?')) { try { await expensesColRef.doc(id).delete(); } catch (e) { console.error(e); } } };

      const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          let dataArray = [];
          if (file.name.endsWith('.xlsx')) {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            dataArray = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, range: 2 });
          } else {
            dataArray = e.target.result.split(/\r?\n/).slice(2).map(line => line.split(','));
          }
          const allNew = dataArray.map((row) => {
            if (!row || row.length < 9 || typeof row[4] !== 'string' || row[4].toLowerCase().includes('inclusao de pagamento')) return null;
            const cardSuffix = row[2] ? String(row[2]).trim() : '';
            let owner, source;
            if (cardSuffix.endsWith('2581')) { owner = 'Guilherme'; source = 'Cartão Guilherme (final 2581)'; }
            else if (cardSuffix.endsWith('1009')) { owner = 'Thais'; source = 'Cartão Thais (final 1009)'; }
            else { owner = 'Digital'; source = 'Cartão Digital (final 7292)'; }
            const amount = typeof row[8] === 'number' ? row[8] : parseBRFloat(String(row[8] || 0));
            if (isNaN(amount) || amount === 0) return null;
            let description = row[4] || 'Sem descrição';
            if (amount < 0) description = `Estorno: ${description}`;
            const parcelaInfo = (row[5] && row[5] !== 'Única') ? String(row[5]) : null;
            return { description, amount, date: row[0] || new Date().toLocaleDateString('pt-BR'), split: 'Dividido', paidBy: owner, paymentSource: source, type: 'Cartão', parcela: parcelaInfo };
          }).filter(Boolean);
          setImportedExpenses(allNew);
          setImportModalOpen(true);
        };
        if (file.name.endsWith('.xlsx')) reader.readAsArrayBuffer(file); else reader.readAsText(file, 'ISO-8859-1');
        event.target.value = null;
      };

      const confirmImport = async () => {
        const unique = importedExpenses.filter(imported =>
          !expenses.some(existing =>
            existing.description === imported.description &&
            Math.abs(existing.amount - imported.amount) < 0.01 &&
            existing.date === imported.date &&
            existing.parcela === imported.parcela
          )
        );
        try {
          const batch = db.batch();
          unique.forEach(expense => batch.set(expensesColRef.doc(), expense));
          await batch.commit();
        } catch (e) { console.error(e); }
        setImportedExpenses([]); setImportModalOpen(false);
      };

      const filteredAndSortedExpenses = useMemo(() => {
        const visible = user === 'Guilherme'
          ? expenses.filter(e => e.paymentSource.includes('2581') || e.paymentSource.includes('7292'))
          : expenses.filter(e => e.paymentSource.includes('1009'));
        let filtered = visible;
        switch (filter) {
          case 'Cartão': filtered = visible.filter(e => e.type === 'Cartão' && !e.parcela); break;
          case 'Parcelados': filtered = visible.filter(e => !!e.parcela); break;
          case 'Pix': filtered = visible.filter(e => e.type === 'Pix'); break;
          case 'Boleto': filtered = visible.filter(e => e.type === 'Boleto'); break;
        }
        return filtered.sort((a, b) => {
          const aDate = new Date(a.date.split('/').reverse().join('-'));
          const bDate = new Date(b.date.split('/').reverse().join('-'));
          if (filter === 'Todos') {
            const aIsParc = !!a.parcela, bIsParc = !!b.parcela;
            if (aIsParc !== bIsParc) return aIsParc ? 1 : -1;
          }
          return bDate - aDate;
        });
      }, [expenses, filter, user]);

      const totals = useMemo(() => {
        let userTotal = 0, otherUserTotal = 0;
        expenses.forEach(e => {
          if (e.split === 'Dividido') { userTotal += e.amount / 2; otherUserTotal += e.amount / 2; }
          else if (e.split === user) userTotal += e.amount;
          else if (e.split === otherUser) otherUserTotal += e.amount;
        });
        const userPaid = expenses.filter(e => e.paidBy === user).reduce((s, e) => s + e.amount, 0);
        const otherPaid = expenses.filter(e => e.paidBy === otherUser).reduce((s, e) => s + e.amount, 0);
        const balance = otherUserTotal - otherPaid;
        const g = expenses.filter(e => e.paymentSource.includes('2581')).reduce((s, e) => s + e.amount, 0);
        const t = expenses.filter(e => e.paymentSource.includes('1009')).reduce((s, e) => s + e.amount, 0);
        const d = expenses.filter(e => e.paymentSource.includes('7292')).reduce((s, e) => s + e.amount, 0);
        const grand = g + t + d;
        const liberar = expenses.filter(e => {
          const isUserCard = user === 'Guilherme' ? (e.paymentSource.includes('2581') || e.paymentSource.includes('7292')) : e.paymentSource.includes('1009');
          if (!isUserCard || !e.parcela || typeof e.parcela !== 'string') return false;
          const [current, total] = e.parcela.split('/').map(Number);
          return current === total;
        }).reduce((s, e) => s + e.amount, 0);
        return { userTotal, otherUserTotal, userPaid, otherPaid, balance, g, t, d, grand, liberar };
      }, [expenses, user, otherUser]);

      const FilterButton = ({ label }) => {
        const isActive = filter === label;
        return (
          <button onClick={() => setFilter(label)}
            className={`px-3 py-1.5 text-sm font-semibold rounded-full transition ${isActive ? `${theme.bg} text-white shadow` : 'bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600'}`}>
            {label}
          </button>
        );
      };

      return (
        <div className="max-w-4xl mx-auto p-4 pb-24">
          <header className="flex justify-between items-start mb-6">
            <div>
              <h1 className="text-2xl font-bold">Olá, {user}</h1>
              <p className="text-slate-500 dark:text-slate-400">Resumo das suas despesas.</p>
            </div>
            <div className="flex items-start space-x-6">
              <div className="text-right text-sm">
                <div>
                  <h3 className="font-semibold text-slate-600 dark:text-slate-400 mb-1">Total Faturas</h3>
                  <div className="space-y-1 text-slate-500 dark:text-slate-400">
                    <p>Guilherme: <span className="font-bold text-slate-700 dark:text-slate-300">{formatBRL(totals.g)}</span></p>
                    <p>Thais: <span className="font-bold text-slate-700 dark:text-slate-300">{formatBRL(totals.t)}</span></p>
                    <p>Digital: <span className="font-bold text-slate-700 dark:text-slate-300">{formatBRL(totals.d)}</span></p>
                    <hr className="my-2 border-slate-200 dark:border-slate-700" />
                    <p className="font-bold">Total Geral: <span className={`${theme.text} ${theme.darkText}`}>{formatBRL(totals.grand)}</span></p>
                  </div>
                </div>
                {totals.liberar > 0 && (
                  <div className="mt-4">
                    <h3 className="font-semibold text-slate-600 dark:text-slate-400 mb-1">Próximo Mês</h3>
                    <p className="text-slate-500 dark:text-slate-400">Limite liberado:
                      <span className="font-bold text-emerald-500 dark:text-emerald-400 ml-1">{formatBRL(totals.liberar)}</span>
                    </p>
                  </div>
                )}
              </div>
              <button onClick={onLogout} className={`text-slate-500 hover:${theme.text} dark:hover:${theme.darkText} transition`}>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
              </button>
            </div>
          </header>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md">
              <h3 className="font-semibold mb-2 text-slate-600 dark:text-slate-400">Resultado Final</h3>
              {totals.balance >= 0 ? (
                <div><p className="text-sm">{otherUser} deve te pagar</p><p className="text-3xl font-bold text-emerald-500">{formatBRL(totals.balance)}</p></div>
              ) : (
                <div><p className="text-sm">Você deve pagar para {otherUser}</p><p className="text-3xl font-bold text-red-500">{formatBRL(Math.abs(totals.balance))}</p></div>
              )}
            </div>
            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md">
              <h3 className="font-semibold mb-2 text-slate-600 dark:text-slate-400">Detalhes</h3>
              <div className="text-sm space-y-2">
                <p>Sua parte: <span className="font-semibold">{formatBRL(totals.userTotal)}</span></p>
                <p>Parte de {otherUser}: <span className="font-semibold">{formatBRL(totals.otherUserTotal)}</span></p>
                <p>Total pago por você: <span className="font-semibold">{formatBRL(totals.userPaid)}</span></p>
                <p>Total pago por {otherUser}: <span className="font-semibold">{formatBRL(totals.otherPaid)}</span></p>
              </div>
            </div>
          </div>

          <div className="flex space-x-2 mb-6">
            <button onClick={openAddModal} className={`flex-1 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition flex items-center justify-center ${theme.bg} ${theme.hoverBg}`}>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Adicionar
            </button>
            <label htmlFor="file-upload" className="cursor-pointer flex-1 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-semibold py-3 px-4 rounded-xl shadow-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Importar
            </label>
            <input id="file-upload" type="file" className="hidden" accept=".csv, .xlsx" onChange={handleFileUpload} />
          </div>

          <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-md">
            <div className="flex justify-between items-center mb-4 px-2">
              <h2 className="text-xl font-bold">Lançamentos</h2>
              <div className="flex space-x-2">
                <FilterButton label="Todos" /><FilterButton label="Cartão" /><FilterButton label="Parcelados" /><FilterButton label="Pix" /><FilterButton label="Boleto" />
              </div>
            </div>
            <div className="space-y-2">
              {filteredAndSortedExpenses.length > 0 ? filteredAndSortedExpenses.map(expense => {
                const borderClass = expense.split === 'Guilherme' ? themes.Guilherme.borderClass : expense.split === 'Thais' ? themes.Thais.borderClass : 'border-transparent';
                let isLast = false;
                if (expense.parcela) { const [c, t] = expense.parcela.split('/').map(Number); if (c === t) isLast = true; }
                return (
                  <div key={expense.id} className={`flex items-center p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 border-l-4 transition-all ${borderClass}`}>
                    <div className="flex-1 pl-3">
                      <p className="font-semibold flex items-center">
                        {expense.description}
                        {expense.parcela && (
                          <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ml-2 ${isLast ? 'bg-emerald-100 dark:bg-emerald-800/50 text-emerald-700 dark:text-emerald-300' : 'bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300'}`}>
                            {expense.parcela}
                          </span>
                        )}
                      </p>
                      <p className="text-sm text-slate-500 dark:text-slate-400">{expense.date} - {expense.paymentSource || expense.paidBy} - {expense.split} - {expense.type}</p>
                    </div>
                    <div className="text-right">
                      <p className={`font-semibold text-lg ${expense.amount < 0 ? 'text-emerald-500' : ''}`}>{formatBRL(expense.amount)}</p>
                    </div>
                    <div className="ml-4 flex items-center space-x-2">
                      <button onClick={() => openEditModal(expense)} className="text-slate-500 hover:text-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                      </button>
                      <button onClick={() => deleteExpense(expense.id)} className="text-slate-500 hover:text-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                      </button>
                    </div>
                  </div>
                );
              }) : (
                <p className="text-center text-slate-500 dark:text-slate-400 py-8">Nenhum lançamento para este filtro.</p>
              )}
            </div>
          </div>

          <ExpenseForm
            isOpen={isModalOpen}
            onClose={() => setIsModalOpen(false)}
            expense={editingExpense}
            currentUser={user}
            theme={theme}
            addSingleExpense={addSingleExpense}
            addInstallmentPlan={addInstallmentPlan}
            updateExpense={updateExpense}
          />

          <Modal isOpen={isImportModalOpen} onClose={() => setImportModalOpen(false)}>
            <div className="p-6">
              <h2 className="text-xl font-bold mb-4">Confirmar Importação</h2>
              <p className="mb-6">
                Você está prestes a adicionar {importedExpenses.filter(i =>
                  !expenses.some(e => e.description === i.description && Math.abs(e.amount - i.amount) < 0.01 && e.date === i.date && e.parcela === i.parcela)
                ).length} novos lançamentos. Deseja continuar?
              </p>
              <div className="flex justify-end space-x-3">
                <button onClick={() => setImportModalOpen(false)} className="px-4 py-2 rounded-lg bg-slate-2 00 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">Cancelar</button>
                <button onClick={confirmImport} className={`${theme.bg} ${theme.hoverBg} px-4 py-2 rounded-lg text-white font-semibold`} disabled={importedExpenses.length === 0}>Confirmar</button>
              </div>
            </div>
          </Modal>
        </div>
      );
    };

    const ExpenseForm = ({ isOpen, onClose, expense, currentUser, theme, addSingleExpense, addInstallmentPlan, updateExpense }) => {
      const [description, setDescription] = useState('');
      const [amount, setAmount] = useState('');
      const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
      const [paymentSource, setPaymentSource] = useState('');
      const [split, setSplit] = useState('Dividido');
      const [type, setType] = useState('Cartão');
      const [totalInstallments, setTotalInstallments] = useState('1');
      const otherUser = currentUser === 'Guilherme' ? 'Thais' : 'Guilherme';

      useEffect(() => {
        const defaultSource = currentUser === 'Guilherme' ? 'Cartão Guilherme (final 2581)' : 'Cartão Thais (final 1009)';
        if (expense) {
          setDescription(expense.description);
          setAmount(String(expense.amount).replace('.', ','));
          setDate(expense.date ? new Date(expense.date.split('/').reverse().join('-')).toISOString().split('T')[0] : '');
          setPaymentSource(expense.paymentSource || defaultSource);
          setSplit(expense.split);
          setType(expense.type || 'Cartão');
          setTotalInstallments(expense.parcela ? expense.parcela.split('/')[1] : '1');
        } else {
          setDescription(''); setAmount(''); setDate(new Date().toISOString().split('T')[0]);
          setPaymentSource(defaultSource); setSplit('Dividido'); setType('Cartão'); setTotalInstallments('1');
        }
      }, [expense, isOpen, currentUser]);

      const handleSubmit = (e) => {
        e.preventDefault();
        const paidBy = paymentSource.includes('Guilherme') ? 'Guilherme' : (paymentSource.includes('Thais') ? 'Thais' : 'Digital');
        if (expense) {
          updateExpense({ ...expense, description, amount: parseBRFloat(amount), date: new Date(date).toLocaleDateString('pt-BR', {timeZone: 'UTC'}), split, type, paymentSource, paidBy });
        } else {
          const n = parseInt(totalInstallments, 10) || 1;
          if (n > 1) addInstallmentPlan({ description, totalAmount: parseBRFloat(amount), numberOfInstallments: n, startDate: new Date(date).toLocaleDateString('pt-BR', {timeZone: 'UTC'}), split, type, paymentSource, paidBy });
          else addSingleExpense({ description, amount: parseBRFloat(amount), date: new Date(date).toLocaleDateString('pt-BR', {timeZone: 'UTC'}), split, type, paymentSource, paidBy, parcela: null });
        }
        onClose();
      };

      const inputClasses = `mt-1 block w-full bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md shadow-sm ${theme.ring} ${theme.border}`;

      return (
        <Modal isOpen={isOpen} onClose={onClose}>
          <form onSubmit={handleSubmit} className="p-6 space-y-4">
            <h2 className="text-xl font-bold mb-4">{expense ? 'Editar Lançamento' : 'Novo Lançamento'}</h2>
            <div>
              <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Descrição</label>
              <input type="text" value={description} onChange={e => setDescription(e.target.value)} required className={inputClasses} />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Valor {expense ? '(da parcela)' : '(Total)'} (R$)</label>
                <input type="text" value={amount} onChange={e => setAmount(e.target.value)} placeholder="123,45" required className={inputClasses} />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Nº de Parcelas</label>
                <input type="number" value={totalInstallments} onChange={e => setTotalInstallments(e.target.value)} min="1" disabled={!!expense} required className={`${inputClasses} disabled:opacity-50`} />
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Data {expense ? '(do lançamento)' : '(da 1ª parcela)'}</label>
              <input type="date" value={date} onChange={e => setDate(e.target.value)} required className={inputClasses} />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Pago com</label>
              <select value={paymentSource} onChange={e => setPaymentSource(e.target.value)} className={inputClasses}>
                <option>Cartão Guilherme (final 2581)</option>
                <option>Cartão Thais (final 1009)</option>
                <option>Cartão Digital (final 7292)</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Divisão da despesa</label>
              <select value={split} onChange={e => setSplit(e.target.value)} className={inputClasses}>
                <option>Dividido</option>
                <option value={currentUser}>Apenas {currentUser}</option>
                <option value="Thais">Apenas Thais</option>
                <option value="Guilherme">Apenas Guilherme</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-600 dark:text-slate-400">Tipo</label>
              <select value={type} onChange={e => setType(e.target.value)} className={inputClasses}>
                <option>Cartão</option><option>Pix</option><option>Boleto</option>
              </select>
            </div>
            <div className="flex justify-end space-x-3 pt-4">
              <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold">Cancelar</button>
              <button type="submit" className={`${theme.bg} ${theme.hoverBg} px-4 py-2 rounded-lg text-white font-semibold`}>Salvar</button>
            </div>
          </form>
        </Modal>
      );
    };

    const App = () => {
      const [currentUser, setCurrentUser] = useState(() => JSON.parse(localStorage.getItem('meuAcertoUser') || 'null'));
      const [db, setDb] = useState(null);
      const [auth, setAuth] = useState(null);
      const [error, setError] = useState(null);

      useEffect(() => {
        const firebaseConfig = {
          apiKey: "AIzaSyCeeZ8a4rPnf26IItU-HaaeRpcv5xPTkK",
          authDomain: "meu-acerto-app.firebaseapp.com",
          projectId: "meu-acerto-app",
          storageBucket: "meu-acerto-app.appspot.com",
          messagingSenderId: "326484473567",
          appId: "1:326484473567:web:8315e86731be0071f33c2"
        };

        try {
          if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
          const firestoreDb = firebase.firestore();
          const firebaseAuth = firebase.auth();

          setDb(firestoreDb);
          setAuth(firebaseAuth);

          // <<< authenticate() atualizado >>>
          const authenticate = async () => {
            try {
              await firebaseAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
              await firebaseAuth.signInAnonymously();
              console.log("Auth OK");
            } catch (err) {
              console.error("Auth error:", err);
              setError(`Erro [${err.code}] ${err.message}`);
            }
          };
          authenticate();
        } catch (err) {
          console.error("Failed to initialize Firebase:", err);
          setError("Falha ao inicializar o Firebase. Verifique as credenciais.");
        }
      }, []);

      const handleSelectUser = (user) => { setCurrentUser(user); localStorage.setItem('meuAcertoUser', JSON.stringify(user)); };
      const handleLogout = () => { setCurrentUser(null); localStorage.removeItem('meuAcertoUser'); };

      if (error) return <div className="min-h-screen flex items-center justify-center text-red-500 font-semibold p-4 text-center">{error}</div>;
      if (!db || !auth) return <div className="min-h-screen flex items-center justify-center text-slate-500">Conectando ao servidor...</div>;
      if (!currentUser) return <UserSelectionScreen onSelectUser={handleSelectUser} />;

      return <Dashboard user={currentUser} onLogout={handleLogout} db={db} />;
    };

    window.onload = () => {
      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    };
  </script>
</body>
</html>
