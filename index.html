<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meu Acerto</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Meu Acerto" />
  <meta name="theme-color" content="#4338ca" />
  <link rel="apple-touch-icon" href="https://placehold.co/180x180/4338ca/ffffff?text=Acerto" />

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase Modular SDK (Versão Web Padrão) -->
  <script type="module">
    // Importamos as funções necessárias diretamente do CDN oficial
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { 
      getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, 
      onSnapshot, runTransaction, writeBatch, query, where, getDocs, enableIndexedDbPersistence 
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { 
      getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence 
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    // Expõe as funções para o escopo global do React (Babel)
    window.FirebaseLib = {
      initializeApp, getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
      onSnapshot, runTransaction, writeBatch, query, where, getDocs, enableIndexedDbPersistence,
      getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence
    };
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .modal-enter { animation: fadeIn .2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(.98);} to { opacity: 1; transform: scale(1);} }
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useMemo, useRef } = React;
    const { createRoot } = ReactDOM;

    /* ========= Helpers ========= */
    const norm = (s) => (s ?? '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase();

    const canonicalSplit = (s) => {
      const n = norm(s);
      if (n.includes('guilherme')) return 'Guilherme';
      if (n.includes('thais')) return 'Thais';
      return 'Dividido';
    };

    const parseMoney = (input) => {
      if (typeof input === 'number') return input;
      if (input == null || input === '') return NaN;
      let s = String(input).replace(/\s+/g, '').trim();
      const parenNeg = /^\(.*\)$/.test(s);
      const trailingNeg = /-$/.test(s);
      if (parenNeg) s = s.replace(/[()]/g, '');
      if (trailingNeg) s = s.slice(0, -1);
      const negativeSign = parenNeg || trailingNeg;
      const leadingNegative = s.startsWith('-');
      if (leadingNegative) s = s.slice(1);

      let n;
      const hasComma = s.includes(',');
      const hasDot = s.includes('.');

      if (hasComma && !hasDot) { n = parseFloat(s.replace(',', '.')); }
      else if (hasDot && !hasComma) {
        if (s.indexOf('.') === s.lastIndexOf('.') && s.length - s.indexOf('.') <= 3) { n = parseFloat(s); } 
        else { n = parseFloat(s.replace(/\./g, '')); }
      } else if (hasComma && hasDot) {
        const lastComma = s.lastIndexOf(',');
        const lastDot = s.lastIndexOf('.');
        if (lastComma > lastDot) { n = parseFloat(s.replace(/\./g, '').replace(',', '.')); } 
        else { n = parseFloat(s.replace(/,/g, '')); }
      } else { n = parseFloat(s); }
      return Number.isFinite(n) ? ((negativeSign || leadingNegative) ? -n : n) : NaN;
    };

    const excelSerialToPT = (v) => {
      if (typeof v === 'number') {
        const ms = Math.round((v - 25569) * 86400 * 1000);
        return new Date(ms).toLocaleDateString('pt-PT', { timeZone: 'UTC' });
      }
      if (typeof v === 'string') {
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) return v;
        if (/^\d{4}-\d{2}-\d{2}/.test(v)) return new Date(v).toLocaleDateString('pt-PT', { timeZone: 'UTC' });
        const m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})$/);
        if (m) return `${m[1].padStart(2,'0')}/${m[2].padStart(2,'0')}/20${m[3]}`;
      }
      return new Date().toLocaleDateString('pt-PT', { timeZone: 'UTC' });
    };

    const formatBRL = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL'}).format(v || 0);
    const round2 = (v) => Math.round((v + Number.EPSILON) * 100) / 100;

    const ptDateToDateObj = (pt) => {
      const m = String(pt || '').match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (!m) return null;
      return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]), 12);
    };

    const monthKeyFromPtDate = (pt) => {
      const m = String(pt || '').match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (!m) return null;
      return `${m[3]}-${m[2]}`;
    };

    const monthKeyFromDateObj = (d) => {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2,'0');
      return `${yyyy}-${mm}`;
    };

    const currentMonthKey = () => monthKeyFromDateObj(new Date());

    const monthLabel = (monthKey) => {
      if (!monthKey) return '';
      const [yyyy, mm] = monthKey.split('-').map(Number);
      const d = new Date(yyyy, mm - 1, 1);
      const nomeMes = d.toLocaleDateString('pt-BR', { month: 'long' });
      return `${nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1)} ${yyyy}`;
    };

    const shiftMonthKey = (monthKey, delta) => {
      if (!monthKey) return currentMonthKey();
      const [yyyy, mm] = monthKey.split('-').map(Number);
      const d = new Date(yyyy, mm - 1 + delta, 1);
      return monthKeyFromDateObj(d);
    };

    const ownerFromPaymentSource = (src) => {
      const s = norm(src);
      if (!s) return null;
      if (s.includes('2581') || s.includes('guilherme')) return 'Guilherme';
      if (s.includes('1009') || s.includes('thais')) return 'Thais';
      if (s.includes('7292') || s.includes('digital')) return 'Ambos';
      return null;
    };

    /* ========= Componentes UI ========= */

    const Modal = ({ isOpen, onClose, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black/60 flex justify-center items-center p-4 z-50 modal-enter" onClick={onClose}>
          <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md m-4 outline-none" onClick={(e)=>e.stopPropagation()}>
            {children}
          </div>
        </div>
      );
    };

    const UserSelectionScreen = ({ onSelectUser }) => {
      return (
        <div className="min-h-screen flex flex-col justify-center items-center p-6">
          <h1 className="text-4xl font-bold mb-2">Meu Acerto</h1>
          <p className="text-lg text-slate-600 dark:text-slate-400 mb-8">Quem está a usar?</p>
          <div className="space-y-4 w-full max-w-xs">
            {['Guilherme', 'Thais'].map(u => (
              <button key={u} onClick={() => onSelectUser(u)}
                className={`w-full py-3 rounded-xl text-white font-semibold shadow-lg hover:brightness-110 transition
                  ${u === 'Thais' ? 'bg-pink-600' : 'bg-indigo-600'}`}>
                {u}
              </button>
            ))}
          </div>
        </div>
      );
    };

    /* ========= Dashboard ========= */

    const Dashboard = ({ user, onLogout, db }) => {
      const [expenses, setExpenses] = useState([]);
      const [installmentPlans, setInstallmentPlans] = useState([]);
      
      const [currentMonth, setCurrentMonth] = useState(currentMonthKey);
      const [filterType, setFilterType] = useState('Todos');
      const [scope, setScope] = useState('geral'); // 'geral' | 'cartao' | 'pixboleto'

      const [isAddOpen, setIsAddOpen] = useState(false);
      const [isImportOpen, setIsImportOpen] = useState(false);
      const [isClearOpen, setIsClearOpen] = useState(false);
      const [isDelOpen, setDelOpen] = useState(false);
      
      const [delTarget, setDelTarget] = useState(null);
      const [deleting, setDeleting] = useState(false);
      const [importedExpenses, setImportedExpenses] = useState([]);
      const [isImporting, setIsImporting] = useState(false);
      const fileInputRef = useRef(null);

      // Form fields
      const [fDesc, setFDesc] = useState('');
      const [fValor, setFValor] = useState('');
      const [fData, setFData] = useState(() => new Date().toLocaleDateString('pt-PT', { timeZone: 'UTC' }));
      const [fTipo, setFTipo] = useState('Cartão');
      const [fSplit, setFSplit] = useState('Dividido');
      const [fFonte, setFFonte] = useState(user === 'Guilherme' ? 'Cartão Guilherme (final 2581)' : 'Cartão Thais (final 1009)');
      const [fParcela, setFParcela] = useState('');
      const [salvando, setSalvando] = useState(false);
      const [editingId, setEditingId] = useState(null);

      // Firebase Globals
      const { collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, runTransaction, writeBatch } = window.FirebaseLib;

      const theme = user === 'Thais' 
        ? { text:'text-pink-600', bg:'bg-pink-600', hover:'hover:bg-pink-700' }
        : { text:'text-indigo-600', bg:'bg-indigo-600', hover:'hover:bg-indigo-700' };

      // Máscara de valor
      const valorRef = useRef(null);
      const formatBRLInput = (digits, negative=false) => {
        const n = (Number(digits) || 0) / 100;
        const fmt = n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        return negative ? `-${fmt}` : fmt;
      };
      const handleValorChange = (e) => {
        const raw = e.target.value;
        const negative = raw.trim().startsWith('-');
        const digits = raw.replace(/\D/g, '');
        if (!digits) { setFValor(negative ? '-' : ''); return; }
        setFValor(formatBRLInput(digits, negative));
      };

      // Listeners (PRODUÇÃO: Usando coleções na raiz)
      useEffect(() => {
        if (!db) return;
        const expRef = collection(db, 'expenses');
        const plansRef = collection(db, 'installmentPlans');

        const unsub1 = onSnapshot(expRef, (s) => setExpenses(s.docs.map(d => ({ id: d.id, ...d.data() }))));
        const unsub2 = onSnapshot(plansRef, (s) => setInstallmentPlans(s.docs.map(d => ({ id: d.id, ...d.data() }))));
        return () => { unsub1(); unsub2(); };
      }, [db]);

      // Migração Automática (monthKey)
      useEffect(() => {
        if (!db || !expenses.length) return;
        const toFix = expenses.filter(e => !e.monthKey && e.date);
        if (!toFix.length) return;
        
        const batch = writeBatch(db);
        let count = 0;
        const expRef = collection(db, 'expenses');
        
        toFix.forEach(e => {
          const mk = monthKeyFromPtDate(e.date);
          if (mk) {
            batch.update(doc(expRef, e.id), { monthKey: mk });
            count++;
          }
        });
        if (count > 0) batch.commit().catch(console.error);
      }, [expenses, db]);

      // Geração de Parcelas
      useEffect(() => {
        if (!installmentPlans.length || !db) return;
        
        const generate = async () => {
            const batch = writeBatch(db);
            let hasWrites = false;
            const expRef = collection(db, 'expenses');

            for (const plan of installmentPlans) {
                if (!plan.startDate || !plan.numberOfInstallments || !plan.totalAmount) continue;
                
                const parts = String(plan.startDate).split('/');
                if (parts.length !== 3) continue;
                const [dd, mm, yyyy] = parts.map(Number);
                const start = new Date(yyyy, mm - 1, dd, 12);
                
                const deletedSet = new Set(plan.deletedParcels || []);
                const per = round2(plan.totalAmount / plan.numberOfInstallments);
                const last = round2(plan.totalAmount - per * (plan.numberOfInstallments - 1));

                for (let i = 0; i < plan.numberOfInstallments; i++) {
                    const d = new Date(start.getFullYear(), start.getMonth() + i, start.getDate(), 12);
                    const num = i + 1;
                    const parcelaKey = `${num}/${plan.numberOfInstallments}`;
                    if (deletedSet.has(parcelaKey)) continue;

                    const mk = monthKeyFromDateObj(d);
                    const dateStr = d.toLocaleDateString('pt-PT', { timeZone: 'UTC' });
                    const amount = num === plan.numberOfInstallments ? last : per;

                    // Deduplicação (procura localmente no state antes de criar)
                    const exists = expenses.some(e => 
                        e.installmentPlanId === plan.id && 
                        e.parcela === parcelaKey &&
                        e.monthKey === mk
                    );

                    if (!exists) {
                        const newRef = doc(expRef);
                        batch.set(newRef, {
                            installmentPlanId: plan.id,
                            description: plan.description,
                            amount,
                            date: dateStr,
                            parcela: parcelaKey,
                            split: plan.split || 'Dividido',
                            type: plan.type || 'Cartão',
                            paymentSource: plan.paymentSource || 'Cartão',
                            paidBy: 'Cartão',
                            monthKey: mk
                        });
                        hasWrites = true;
                    }
                }
            }
            if (hasWrites) await batch.commit();
        };
        generate();
      }, [installmentPlans, expenses, db]);

      /* ==== Cálculos ==== */
      const availableMonths = useMemo(() => {
        const set = new Set(expenses.map(e => e.monthKey).filter(Boolean));
        set.add(currentMonth);
        return Array.from(set).sort();
      }, [expenses, currentMonth]);

      const expensesCurrentMonth = useMemo(() => expenses.filter(e => e.monthKey === currentMonth), [expenses, currentMonth]);

      const expensesForScope = useMemo(() => {
        let base = expensesCurrentMonth;
        if (scope === 'cartao') base = base.filter(e => e.type === 'Cartão');
        else if (scope === 'pixboleto') base = base.filter(e => ['Pix', 'Boleto', 'Ajuste'].includes(e.type));
        return base;
      }, [expensesCurrentMonth, scope]);

      const filteredList = useMemo(() => {
        let base = expensesCurrentMonth;
        if (filterType !== 'Todos') base = base.filter(e => e.type === filterType);
        return base.sort((a,b) => {
            const da = ptDateToDateObj(a.date);
            const db = ptDateToDateObj(b.date);
            return (da && db) ? da - db : 0;
        });
      }, [expensesCurrentMonth, filterType]);

      const { partG, partT, gPaid, tPaid } = useMemo(() => {
        let pG = 0, pT = 0, paidG = 0, paidT = 0;
        for (const e of expensesForScope) {
            const val = Number(e.amount || 0);
            if (e.split === 'Dividido') { pG += val/2; pT += val/2; }
            else if (e.split === 'Guilherme') pG += val;
            else if (e.split === 'Thais') pT += val;

            if (e.type === 'Cartão') {
                const owner = ownerFromPaymentSource(e.paymentSource);
                if (owner === 'Guilherme') paidG += val;
                else if (owner === 'Thais') paidT += val;
                else if (owner === 'Ambos') { paidG += val/2; paidT += val/2; }
            } else {
                if (e.paidBy === 'Guilherme') paidG += val;
                else if (e.paidBy === 'Thais') paidT += val;
            }
        }
        return { partG: round2(pG), partT: round2(pT), gPaid: round2(paidG), tPaid: round2(paidT) };
      }, [expensesForScope]);

      const difGastos = round2(partG - partT);
      const valorDevolverSePagarTudo = user === 'Guilherme' ? round2(gPaid - partG) : round2(tPaid - partT);

      const saldoDevedorThais = useMemo(() => {
         let pG=0, paidG=0;
         for (const e of expensesCurrentMonth) {
            const val = Number(e.amount || 0);
            if (e.split === 'Dividido') pG += val/2;
            else if (e.split === 'Guilherme') pG += val;

            if (e.type === 'Cartão') {
                const owner = ownerFromPaymentSource(e.paymentSource);
                if (owner === 'Guilherme') paidG += val;
                else if (owner === 'Ambos') paidG += val/2;
            } else {
                if (e.paidBy === 'Guilherme') paidG += val;
            }
         }
         return round2(paidG - pG);
      }, [expensesCurrentMonth]);

      const cardTotals = useMemo(() => {
        let tot=0, g=0, t=0, d=0;
        for (const e of expensesCurrentMonth) {
            if (e.type !== 'Cartão') continue;
            const val = Number(e.amount||0);
            tot+=val;
            const o = ownerFromPaymentSource(e.paymentSource);
            if (o === 'Guilherme') g+=val;
            else if (o === 'Thais') t+=val;
            else if (o === 'Ambos') d+=val;
        }
        return { grandTotal: round2(tot), gCard: round2(g), tCard: round2(t), dCard: round2(d) };
      }, [expensesCurrentMonth]);

      /* ==== Ações ==== */
      const salvarLancamento = async () => {
        const val = parseMoney(fValor);
        if (!fDesc || !Number.isFinite(val)) return;
        const mk = monthKeyFromPtDate(fData) || currentMonth;

        setSalvando(true);
        const expRef = collection(db, 'expenses');
        const payload = {
            description: fDesc, amount: val, date: fData, 
            split: fTipo==='Ajuste'?'Thais':fSplit,
            type: fTipo, 
            paymentSource: fTipo==='Cartão'?fFonte:fTipo,
            paidBy: fTipo==='Cartão'?'Cartão':(fTipo==='Ajuste'?'Thais':user),
            monthKey: mk,
            parcela: fParcela || null
        };

        try {
            if (editingId) await updateDoc(doc(expRef, editingId), payload);
            else await addDoc(expRef, payload);
            setIsAddOpen(false);
            setFDesc(''); setFValor(''); setFParcela('');
        } catch(e) { console.error(e); }
        setSalvando(false);
      };

      const handleFileChange = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        setIsImporting(true);
        try {
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
            
            const [header, ...body] = rows;
            const idxDate = header.findIndex(h => norm(h).includes('data'));
            const idxDesc = header.findIndex(h => norm(h).includes('desc'));
            const idxVal  = header.findIndex(h => norm(h).includes('valor'));
            
            const mapped = [];
            for (const row of body) {
                if (!row[idxDate] || !row[idxDesc]) continue;
                const dateStr = excelSerialToPT(row[idxDate]);
                const amount = parseMoney(row[idxVal]);
                if (!Number.isFinite(amount)) continue;
                
                mapped.push({
                    description: String(row[idxDesc]).trim(),
                    amount: round2(amount),
                    date: dateStr,
                    type: 'Cartão',
                    paymentSource: 'Cartão',
                    split: 'Dividido',
                    paidBy: 'Cartão',
                    monthKey: monthKeyFromPtDate(dateStr) || currentMonth,
                    parcela: null
                });
            }
            setImportedExpenses(mapped);
            setIsImportOpen(true);
        } catch(err) { console.error(err); }
        setIsImporting(false);
        if (fileInputRef.current) fileInputRef.current.value = '';
      };

      const confirmImport = async () => {
        if (!importedExpenses.length) return;
        const batch = writeBatch(db);
        const expRef = collection(db, 'expenses');
        let count = 0;
        importedExpenses.forEach(imp => {
            const exists = expenses.some(e => 
                e.monthKey === imp.monthKey &&
                e.date === imp.date &&
                e.amount === imp.amount &&
                e.description === imp.description
            );
            if (!exists) { batch.set(doc(expRef), imp); count++; }
        });
        if (count > 0) await batch.commit();
        setIsImportOpen(false);
        setImportedExpenses([]);
      };

      const doDelete = async () => {
        if (!delTarget) return;
        setDeleting(true);
        const expRef = doc(db, 'expenses', delTarget.id);
        try {
             if (delTarget.installmentPlanId && delTarget.parcela) {
                 const planRef = doc(db, 'installmentPlans', delTarget.installmentPlanId);
                 await runTransaction(db, async (t) => {
                     const planSnap = await t.get(planRef);
                     if (planSnap.exists()) {
                         const data = planSnap.data();
                         const deleted = data.deletedParcels || [];
                         t.update(planRef, { deletedParcels: [...deleted, delTarget.parcela] });
                     }
                     t.delete(expRef);
                 });
             } else { await deleteDoc(expRef); }
             setDelTarget(null);
             setDelOpen(false);
        } catch(e) { console.error(e); }
        setDeleting(false);
      };

      const clearAll = async () => {
         const q = query(collection(db, 'expenses'));
         const snap = await window.FirebaseLib.getDocs(q);
         const batch = writeBatch(db);
         snap.forEach(d => batch.delete(d.ref));
         await batch.commit();
         setIsClearOpen(false);
      };

      /* ==== Render ==== */
      return (
        <div className="min-h-screen flex flex-col pb-12">
            <header className="bg-white dark:bg-slate-800 shadow-sm px-4 py-3 flex justify-between items-center sticky top-0 z-10">
                <div className="flex items-center gap-2">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold ${theme.bg}`}>{user[0]}</div>
                    <div>
                        <h1 className="font-bold text-sm sm:text-base">Meu Acerto</h1>
                        <p className="text-xs text-slate-500">Mês: {monthLabel(currentMonth)}</p>
                    </div>
                </div>
                <div className="flex items-center gap-2">
                   <div className="hidden sm:flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                       {['geral','cartao','pixboleto'].map(s => (
                           <button key={s} onClick={()=>setScope(s)} className={`px-3 py-1 rounded-md text-xs font-medium transition ${scope===s ? 'bg-white dark:bg-slate-600 shadow text-indigo-600' : 'text-slate-500'}`}>
                               {s==='geral'?'Geral':s==='cartao'?'Cartão':'Pix'}
                           </button>
                       ))}
                   </div>
                   <button onClick={onLogout} className="p-2 bg-slate-100 dark:bg-slate-700 rounded-lg hover:bg-slate-200">
                       <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                   </button>
                </div>
            </header>

            <main className="max-w-5xl mx-auto w-full p-4 space-y-4">
                {/* Navegação de Mês */}
                <div className="flex items-center justify-between bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm">
                    <button onClick={()=>setCurrentMonth(m => shiftMonthKey(m, -1))} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full">◀</button>
                    <div className="flex items-center gap-2">
                        <select value={currentMonth} onChange={e=>setCurrentMonth(e.target.value)} className="bg-transparent font-semibold text-center outline-none">
                            {availableMonths.map(m => <option key={m} value={m}>{monthLabel(m)}</option>)}
                        </select>
                    </div>
                    <button onClick={()=>setCurrentMonth(m => shiftMonthKey(m, 1))} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full">▶</button>
                </div>

                {/* Cards Resumo */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm">
                        <p className="text-xs text-slate-500 mb-1">Divisão ({scope})</p>
                        <div className="flex justify-between items-end mb-1">
                            <span className="text-sm">Guilherme</span>
                            <span className="font-bold">{formatBRL(partG)}</span>
                        </div>
                        <div className="flex justify-between items-end">
                            <span className="text-sm">Thais</span>
                            <span className="font-bold">{formatBRL(partT)}</span>
                        </div>
                        <div className="mt-2 pt-2 border-t border-slate-100 dark:border-slate-700 flex justify-between text-xs text-slate-500">
                            <span>Diferença</span>
                            <span className="font-semibold text-slate-700 dark:text-slate-300">{formatBRL(difGastos)}</span>
                        </div>
                    </div>

                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm">
                        <p className="text-xs text-slate-500 mb-1">Pagamentos ({scope})</p>
                        <div className="flex justify-between items-end mb-1">
                            <span className="text-sm">Guilherme</span>
                            <span className="font-bold text-emerald-600">{formatBRL(gPaid)}</span>
                        </div>
                        <div className="flex justify-between items-end">
                            <span className="text-sm">Thais</span>
                            <span className="font-bold text-emerald-600">{formatBRL(tPaid)}</span>
                        </div>
                        <div className="mt-2 pt-2 border-t border-slate-100 dark:border-slate-700 text-xs text-slate-500">
                            Se {user} quitar tudo: <span className="font-semibold">{formatBRL(valorDevolverSePagarTudo)}</span>
                        </div>
                    </div>

                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-16 h-16 bg-indigo-50 dark:bg-indigo-900/20 rounded-bl-full -mr-4 -mt-4"></div>
                        <p className="text-xs text-slate-500 mb-1">Saldo Geral (Thais → Gui)</p>
                        <p className={`text-2xl font-extrabold ${saldoDevedorThais > 0 ? 'text-amber-500' : 'text-emerald-500'}`}>{formatBRL(saldoDevedorThais)}</p>
                        <p className="text-[10px] text-slate-400 mt-1">Total faturas: {formatBRL(cardTotals.grandTotal)}</p>
                    </div>
                </div>

                {/* Toolbar */}
                <div className="flex gap-2 overflow-x-auto pb-2">
                    <button onClick={()=>setIsAddOpen(true)} className={`flex-shrink-0 px-4 py-2 rounded-xl text-white font-semibold shadow ${theme.bg} ${theme.hover}`}>+ Novo</button>
                    <button onClick={()=>fileInputRef.current?.click()} className="flex-shrink-0 px-4 py-2 rounded-xl bg-white dark:bg-slate-800 shadow text-slate-600 dark:text-slate-300 hover:bg-slate-50">Importar</button>
                    <input ref={fileInputRef} type="file" hidden onChange={handleFileChange} />
                    <button onClick={()=>setIsClearOpen(true)} className="flex-shrink-0 px-4 py-2 rounded-xl bg-white dark:bg-slate-800 shadow text-red-500 hover:bg-red-50">Limpar</button>
                </div>

                {/* Lista */}
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm overflow-hidden">
                    <div className="flex gap-2 p-3 border-b border-slate-100 dark:border-slate-700 overflow-x-auto">
                         {['Todos','Cartão','Pix','Boleto','Ajuste'].map(f => (
                             <button key={f} onClick={()=>setFilterType(f)} className={`px-3 py-1 rounded-full text-xs transition ${filterType===f ? theme.bg + ' text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-500'}`}>{f}</button>
                         ))}
                    </div>
                    <div className="divide-y divide-slate-100 dark:divide-slate-700">
                        {filteredList.length === 0 && <div className="p-8 text-center text-slate-500 text-sm">Nenhum lançamento neste mês.</div>}
                        {filteredList.map(e => (
                            <div key={e.id} onClick={()=>{setDelTarget(e); setDelOpen(true);}} className="p-3 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700/50 cursor-pointer group transition">
                                <div className="flex-1 min-w-0 pr-2">
                                    <div className="flex items-baseline gap-2">
                                        <span className="font-semibold text-sm truncate">{e.description}</span>
                                        <span className="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-500">{e.type}</span>
                                    </div>
                                    <div className="text-xs text-slate-500 truncate mt-0.5">
                                        {e.date} • {e.paymentSource} {e.parcela && `• ${e.parcela}`}
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className={`font-bold text-sm ${e.amount < 0 ? 'text-emerald-500' : ''}`}>{formatBRL(e.amount)}</div>
                                    <div className="text-[10px] text-slate-400">{e.split}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </main>

            {/* Modais */}
            <Modal isOpen={isAddOpen} onClose={()=>setIsAddOpen(false)}>
                <div className="p-5 space-y-3">
                    <h3 className="font-bold text-lg">Novo Lançamento</h3>
                    <input className="w-full p-2 border rounded" placeholder="Descrição" value={fDesc} onChange={e=>setFDesc(e.target.value)} />
                    <div className="flex gap-2">
                         <input ref={valorRef} className="w-1/2 p-2 border rounded" placeholder="0,00" value={fValor} onChange={handleValorChange} />
                         <input className="w-1/2 p-2 border rounded" placeholder="Data" value={fData} onChange={e=>setFData(e.target.value)} />
                    </div>
                    <div className="flex gap-2">
                         <select className="w-1/2 p-2 border rounded" value={fTipo} onChange={e=>setFTipo(e.target.value)}><option>Cartão</option><option>Pix</option><option>Boleto</option><option disabled={user!=='Thais'}>Ajuste</option></select>
                         <select className="w-1/2 p-2 border rounded" value={fSplit} onChange={e=>setFSplit(e.target.value)} disabled={fTipo==='Ajuste'}><option>Dividido</option><option>Guilherme</option><option>Thais</option></select>
                    </div>
                    {fTipo==='Cartão' && <select className="w-full p-2 border rounded" value={fFonte} onChange={e=>setFFonte(e.target.value)}><option>Cartão Guilherme (final 2581)</option><option>Cartão Thais (final 1009)</option><option>Cartão Digital (final 7292)</option></select>}
                    {fTipo==='Cartão' && <input className="w-full p-2 border rounded" placeholder="Parcela (ex: 1/10)" value={fParcela} onChange={e=>setFParcela(e.target.value)} />}
                    <div className="flex justify-end gap-2 pt-2">
                        <button onClick={salvarLancamento} disabled={salvando} className={`px-4 py-2 rounded text-white ${theme.bg}`}>Salvar</button>
                    </div>
                </div>
            </Modal>
            
            <Modal isOpen={isImportOpen} onClose={()=>setIsImportOpen(false)}>
                <div className="p-5">
                    <h3 className="font-bold mb-2">Confirmar Importação</h3>
                    <p className="text-sm mb-4">Encontrados {importedExpenses.length} itens novos.</p>
                    <div className="max-h-40 overflow-y-auto bg-slate-50 p-2 text-xs mb-4 space-y-1">
                        {importedExpenses.map((e,i)=><div key={i} className="flex justify-between"><span>{e.description}</span><span>{formatBRL(e.amount)}</span></div>)}
                    </div>
                    <button onClick={confirmImport} className={`w-full py-2 rounded text-white ${theme.bg}`}>Importar</button>
                </div>
            </Modal>

            <Modal isOpen={isDelOpen} onClose={()=>setDelOpen(false)}>
                <div className="p-5 text-center">
                    <h3 className="font-bold text-red-500 mb-2">Excluir Lançamento?</h3>
                    <p className="text-sm text-slate-600 mb-4">{delTarget?.description} ({formatBRL(delTarget?.amount)})</p>
                    <div className="flex justify-center gap-2">
                        <button onClick={()=>setDelOpen(false)} className="px-4 py-2 rounded bg-slate-200">Cancelar</button>
                        <button onClick={doDelete} className="px-4 py-2 rounded bg-red-500 text-white">Excluir</button>
                    </div>
                </div>
            </Modal>
            
            <Modal isOpen={isClearOpen} onClose={()=>setIsClearOpen(false)}>
                 <div className="p-5 text-center">
                    <h3 className="font-bold text-red-600 mb-2">LIMPAR TUDO?</h3>
                    <p className="text-xs text-slate-500 mb-4">Isso apaga TODOS os dados de TODOS os meses.</p>
                    <button onClick={clearAll} className="w-full py-2 rounded bg-red-600 text-white">Confirmar</button>
                 </div>
            </Modal>
        </div>
      );
    };

    /* ========= Root ========= */

    const App = () => {
      const [currentUser, setCurrentUser] = useState(() => JSON.parse(localStorage.getItem('meuAcertoUser') || 'null'));
      const [db, setDb] = useState(null);
      const [ready, setReady] = useState(false);
      
      // Bibliotecas carregadas via CDN (Module)
      const { initializeApp, getFirestore, getAuth, signInAnonymously, onAuthStateChanged, enableIndexedDbPersistence } = window.FirebaseLib;

      useEffect(() => {
        // SEU CONFIG DO FIREBASE (COPIADO DO ARQUIVO ORIGINAL)
        const firebaseConfig = {
          apiKey: "AIzaSyCeecZ8a4rPnf26IItU-HaaeRpcv5xPTkk",
          authDomain: "meu-acerto-app.firebaseapp.com",
          projectId: "meu-acerto-app",
          storageBucket: "meu-acerto-app.appspot.com",
          messagingSenderId: "326844075367",
          appId: "1:326844075367:web:0315e86713b1e0071f33c2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);

        // Habilitar cache offline
        enableIndexedDbPersistence(firestore).catch(err => {
             if (err.code == 'failed-precondition') {
                 console.warn('Persistência falhou: múltiplas abas abertas.');
             } else if (err.code == 'unimplemented') {
                 console.warn('Persistência não suportada neste navegador.');
             }
        });

        setDb(firestore);

        // Login Anônimo
        signInAnonymously(auth).catch(console.error);
        
        return onAuthStateChanged(auth, (u) => setReady(!!u));
      }, []);

      if (!ready) return <div className="min-h-screen flex items-center justify-center text-slate-400 animate-pulse">Carregando...</div>;
      if (!currentUser) return <UserSelectionScreen onSelectUser={(u)=>{setCurrentUser(u); localStorage.setItem('meuAcertoUser', JSON.stringify(u));}} />;
      
      return <Dashboard user={currentUser} onLogout={()=>{setCurrentUser(null); localStorage.removeItem('meuAcertoUser');}} db={db} />;
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
    
    // Register SW
    if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
        navigator.serviceWorker.register('sw.js').catch(() => {});
    }
  </script>
</body>
</html>